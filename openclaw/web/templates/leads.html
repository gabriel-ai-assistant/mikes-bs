{% extends "base.html" %}
{% set active = "leads" %}
{% block title %}Leads — Mike's Building System{% endblock %}
{% block head %}
<style>
.kanban{display:flex;gap:1rem;overflow-x:auto;padding-bottom:1rem}
.kanban-col{min-width:280px;flex:1;background:#f1f5f9;border-radius:12px;padding:.75rem}
.kanban-col h6{font-weight:700;font-size:.85rem;text-transform:uppercase;color:#6b7280;margin-bottom:.75rem}
.lead-card{background:#fff;border-radius:8px;padding:.75rem;margin-bottom:.5rem;box-shadow:0 1px 2px rgba(0,0,0,.06)}
.lead-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.12)}
.lead-card .name{font-weight:600;font-size:.95rem}
.lead-card .addr{font-size:.85rem;color:#6b7280}
.lead-card .meta{font-size:.78rem;color:#6b7280}
</style>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-end gap-2 mb-2">
  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#leadExportColumnsModal">Export Columns</button>
  <button class="btn btn-sm btn-outline-success" type="button" onclick="exportLeadsCsv()">Export Leads CSV</button>
</div>
{% set has_any = columns.values()|map('length')|sum > 0 %}
{% if not has_any %}
<div class="empty-state"><i class="bi bi-kanban"></i><h4>No leads yet</h4><p>Leads are created from candidates. Run the pipeline first.</p></div>
{% else %}
<div class="kanban">
{% for status in statuses %}
<div class="kanban-col">
  <h6>{{ status_labels.get(status, status) }} ({{ columns[status]|length }})</h6>
  {% for lead in columns[status] %}
  <div class="lead-card">
    <div class="d-flex justify-content-between align-items-start gap-2">
      <div>
        <div class="name">{{ lead.owner_snapshot.name if lead.owner_snapshot and lead.owner_snapshot.name else (lead.candidate.parcel.owner_name if lead.candidate and lead.candidate.parcel else 'Unknown Owner') }}</div>
        <div class="addr">{{ lead.candidate.parcel.address if lead.candidate and lead.candidate.parcel else 'No address' }}</div>
      </div>
      {% if lead.score_at_promotion is not none %}
      <span class="badge bg-secondary">{{ lead.score_at_promotion }}</span>
      {% endif %}
    </div>

    <div class="meta mt-2">
      {% if lead.promoted_at %}Promoted {{ lead.promoted_at.strftime('%Y-%m-%d') }}{% endif %}
      {% if lead.promoted_by_user %} · by {{ lead.promoted_by_user.username }}{% endif %}
    </div>

    <div class="mt-2 d-flex gap-2">
      <a class="btn btn-sm btn-primary" href="{{ base_url }}/leads/{{ lead.id }}">Open</a>
      <select class="form-select form-select-sm" onchange="updateStatus('{{ lead.id }}',this.value)">
        {% for s in statuses %}<option value="{{ s }}"{% if lead.status==s %} selected{% endif %}>{{ status_labels.get(s, s) }}</option>{% endfor %}
      </select>
    </div>
  </div>
  {% endfor %}
</div>
{% endfor %}
</div>
{% endif %}

<div class="modal fade" id="leadExportColumnsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Lead Export Columns</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="leadExportColumnsBody"></div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="resetLeadExportColumns()">Reset</button>
        <button class="btn btn-sm btn-primary" type="button" data-bs-dismiss="modal">Done</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const BASE = "{{ base_url }}";
const LEAD_EXPORT_COLUMNS_KEY = 'lead_export_columns';
const LEAD_EXPORT_REGISTRY = [
  {key: 'lead_id', label: 'Lead ID', default: true},
  {key: 'status', label: 'Status', default: true},
  {key: 'address', label: 'Address', default: true},
  {key: 'owner_name', label: 'Owner', default: true},
  {key: 'score_at_promotion', label: 'Score At Promotion', default: true},
  {key: 'reason', label: 'Promotion Reason', default: false},
  {key: 'owner_phone', label: 'Owner Phone', default: true},
  {key: 'owner_email', label: 'Owner Email', default: true},
  {key: 'enrichment_phone', label: 'Enrichment Phone', default: true},
  {key: 'enrichment_email', label: 'Enrichment Email', default: true},
  {key: 'osint_status', label: 'OSINT Status', default: true},
  {key: 'osint_summary', label: 'OSINT Summary', default: true},
  {key: 'promoted_at', label: 'Promoted At', default: false},
  {key: 'updated_at', label: 'Updated At', default: true},
];

function defaultLeadExportColumns() {
  return LEAD_EXPORT_REGISTRY.filter((c) => c.default).map((c) => c.key);
}

function getLeadExportColumns() {
  try {
    const raw = localStorage.getItem(LEAD_EXPORT_COLUMNS_KEY);
    if (!raw) return defaultLeadExportColumns();
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed)) return defaultLeadExportColumns();
    const valid = parsed.filter((k) => LEAD_EXPORT_REGISTRY.some((c) => c.key === k));
    return valid.length ? valid : defaultLeadExportColumns();
  } catch (e) {
    return defaultLeadExportColumns();
  }
}

function setLeadExportColumns(cols) {
  localStorage.setItem(LEAD_EXPORT_COLUMNS_KEY, JSON.stringify(cols));
}

function renderLeadExportColumns() {
  const selected = new Set(getLeadExportColumns());
  const container = document.getElementById('leadExportColumnsBody');
  if (!container) return;
  container.innerHTML = '';
  LEAD_EXPORT_REGISTRY.forEach((col) => {
    const row = document.createElement('label');
    row.className = 'form-check d-flex align-items-center gap-2 mb-2';
    row.innerHTML = `<input type="checkbox" class="form-check-input" value="${col.key}" ${selected.has(col.key) ? 'checked' : ''}><span>${col.label}</span>`;
    const input = row.querySelector('input');
    input.addEventListener('change', () => {
      const now = new Set(getLeadExportColumns());
      if (input.checked) now.add(col.key);
      else now.delete(col.key);
      setLeadExportColumns(Array.from(now));
    });
    container.appendChild(row);
  });
}

function resetLeadExportColumns() {
  setLeadExportColumns(defaultLeadExportColumns());
  renderLeadExportColumns();
}

function updateStatus(id,status){
  fetch(BASE+'/api/lead/'+id+'/status?status='+status,{method:'POST'}).then(()=>location.reload());
}

function exportLeadsCsv() {
  const columns = getLeadExportColumns();
  const hasPii = columns.includes('owner_phone') || columns.includes('owner_email') || columns.includes('enrichment_phone') || columns.includes('enrichment_email');
  if (hasPii) {
    const ok = confirm('This export may contain PII (phone/email enrichment data). Continue?');
    if (!ok) return;
  }
  const params = new URLSearchParams();
  params.set('format', 'csv');
  params.set('columns', columns.join(','));
  window.location.href = `${BASE}/api/leads/export?${params.toString()}`;
}

renderLeadExportColumns();
</script>
{% endblock %}
