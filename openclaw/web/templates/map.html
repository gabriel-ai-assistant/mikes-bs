{% extends "base.html" %}
{% block title %}Map — Mike's BS{% endblock %}

{% block content %}
<style>
.legend-panel { position: absolute; z-index: 500; top: 72px; left: 12px; width: 280px; }
.legend-mobile-toggle { display: none; }
.status-swatch { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:6px; vertical-align:middle; }
@media (max-width: 768px) {
  .legend-panel { top: 12px; left: 12px; right: 12px; width: auto; }
  .legend-mobile-toggle { display: inline-block; }
}
</style>

<div class="card border-0 shadow-sm mb-2">
  <div class="card-body py-2 d-flex flex-wrap gap-2 align-items-center">
    <span class="fw-semibold text-muted small">Tier Filter:</span>
    <button class="btn btn-sm btn-success active" onclick="filterTier('')" id="btn-all">All</button>
    <button class="btn btn-sm btn-outline-success" onclick="filterTier('A')" id="btn-A">Tier A</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterTier('B')" id="btn-B">Tier B</button>
    <button class="btn btn-sm btn-outline-warning" onclick="filterTier('C')" id="btn-C">Tier C</button>
    <button class="btn btn-sm btn-outline-secondary" onclick="filterTier('D')" id="btn-D">Tier D</button>
    <button class="btn btn-sm btn-outline-danger" onclick="filterTier('E')" id="btn-E">Tier E</button>
    <button class="btn btn-sm btn-outline-dark" onclick="filterTier('F')" id="btn-F">Tier F</button>
    <div class="vr"></div>
    <span class="small text-muted" id="countLabel">Loading…</span>
  </div>
</div>

<div class="position-relative">
  <div id="map" style="height: calc(100vh - 220px); border-radius: 0.5rem; overflow: hidden;"></div>

  <div class="legend-panel">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
        <strong class="small text-muted">Lead Status Overlay</strong>
        <button class="btn btn-sm btn-outline-secondary legend-mobile-toggle" type="button" onclick="toggleLegend()">Toggle</button>
      </div>
      <div class="card-body py-2" id="legendBody">
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-none" value="none" checked>
          <label class="form-check-label" for="status-none"><span class="status-swatch" style="background:#6c757d"></span>No Lead</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-new" value="new" checked>
          <label class="form-check-label" for="status-new"><span class="status-swatch" style="background:#0d6efd"></span>New</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-researching" value="researching" checked>
          <label class="form-check-label" for="status-researching"><span class="status-swatch" style="background:#ffc107"></span>Researching</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-contacted" value="contacted" checked>
          <label class="form-check-label" for="status-contacted"><span class="status-swatch" style="background:#fd7e14"></span>Contacted</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-negotiating" value="negotiating" checked>
          <label class="form-check-label" for="status-negotiating"><span class="status-swatch" style="background:#6f42c1"></span>Negotiating</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-closed_won" value="closed_won" checked>
          <label class="form-check-label" for="status-closed_won"><span class="status-swatch" style="background:#198754"></span>Closed Won</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-closed_lost" value="closed_lost" checked>
          <label class="form-check-label" for="status-closed_lost"><span class="status-swatch" style="background:#dc3545"></span>Closed Lost</label>
        </div>
        <div class="form-check">
          <input class="form-check-input status-filter" type="checkbox" id="status-dead" value="dead" checked>
          <label class="form-check-label" for="status-dead"><span class="status-swatch" style="background:#dc3545"></span>Dead</label>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>
const BASE = "{{ base_url }}";
const map = L.map('map').setView([47.9, -122.1], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let currentTier = '';
let points = [];

const STATUS_COLORS = {
  none: '#6c757d',
  new: '#0d6efd',
  researching: '#ffc107',
  contacted: '#fd7e14',
  negotiating: '#6f42c1',
  closed_won: '#198754',
  closed_lost: '#dc3545',
  dead: '#dc3545',
};

function normalizeStatus(status) {
  return status || 'none';
}

function statusColor(status) {
  return STATUS_COLORS[normalizeStatus(status)] || STATUS_COLORS.none;
}

function escHtml(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmt(v) {
  return v != null ? '$' + Number(v).toLocaleString() : '—';
}

function fmtSf(v) {
  return v ? `${Number(v).toLocaleString()} sf` : '—';
}

function activeStatuses() {
  const set = new Set();
  document.querySelectorAll('.status-filter').forEach((el) => {
    if (el.checked) set.add(el.value);
  });
  return set;
}

function buildPopupHtml(pt) {
  return `
    <div style="min-width:240px">
      <div class="fw-semibold">${escHtml(pt.address)}</div>
      <div class="small text-muted">${escHtml(pt.owner)}</div>
      <div class="small mt-1"><strong>Lead Status:</strong> ${escHtml(normalizeStatus(pt.lead_status))}</div>
      <div class="small"><strong>OSINT:</strong> ${escHtml(pt.osint_status || '—')}</div>
      <div class="small"><strong>Tier:</strong> ${escHtml(pt.tier || '—')} · <strong>Score:</strong> ${pt.score ?? '—'}</div>
      <div class="small"><strong>Splits:</strong> ${pt.splits ?? '—'} · <strong>Lot:</strong> ${fmtSf(pt.lot_sf)}</div>
      <div class="small"><strong>Zone:</strong> ${escHtml(pt.zone || '—')} · <strong>Value:</strong> ${fmt(pt.value)}</div>
      <a class="btn btn-sm btn-primary mt-2" href="${BASE}/property/${encodeURIComponent(pt.parcel_id || '')}">View Details</a>
    </div>
  `;
}

function renderMarkers() {
  const active = activeStatuses();
  markers.forEach((m) => map.removeLayer(m));
  markers = [];

  const visible = points.filter((pt) => active.has(normalizeStatus(pt.lead_status)));
  document.getElementById('countLabel').textContent = `${visible.length.toLocaleString()} shown`;

  visible.forEach((pt) => {
    const marker = L.circleMarker([pt.lat, pt.lng], {
      radius: pt.tier === 'A' ? 7 : 5,
      fillColor: statusColor(pt.lead_status),
      color: '#fff',
      weight: 1,
      opacity: 0.9,
      fillOpacity: 0.9,
    });
    marker.bindPopup(L.popup({ maxWidth: 300 }).setContent(buildPopupHtml(pt)));
    marker.addTo(map);
    markers.push(marker);
  });
}

async function loadPoints(tier = '') {
  document.getElementById('countLabel').textContent = 'Loading…';
  const url = `${BASE}/api/map/points${tier ? `?tier=${encodeURIComponent(tier)}` : ''}`;
  const fc = await fetch(url).then((r) => r.json());
  points = (fc.features || []).map((f) => {
    const p = f.properties || {};
    const c = f.geometry && f.geometry.coordinates ? f.geometry.coordinates : [null, null];
    return {
      ...p,
      lng: c[0],
      lat: c[1],
    };
  }).filter((pt) => pt.lat != null && pt.lng != null);

  renderMarkers();
}

function filterTier(tier) {
  currentTier = tier;
  ['all','A','B','C','D','E','F'].forEach((t) => {
    const btn = document.getElementById('btn-' + t);
    if (!btn) return;
    btn.classList.remove('active');
  });
  const active = document.getElementById('btn-' + (tier || 'all'));
  if (active) active.classList.add('active');
  loadPoints(tier);
}

function toggleLegend() {
  const body = document.getElementById('legendBody');
  if (!body) return;
  body.style.display = body.style.display === 'none' ? '' : 'none';
}

document.querySelectorAll('.status-filter').forEach((el) => {
  el.addEventListener('change', renderMarkers);
});

loadPoints();
</script>
{% endblock %}
