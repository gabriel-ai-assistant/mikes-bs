{% extends "base.html" %}
{% block title %}Map â€” Mike's BS{% endblock %}

{% block content %}
<!-- Map filter bar -->
<div class="card border-0 shadow-sm mb-2">
  <div class="card-body py-2">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="fw-semibold text-muted small">Filter:</span>
      <button class="btn btn-sm btn-success active" onclick="filterTier('')" id="btn-all">All</button>
      <button class="btn btn-sm btn-outline-success" onclick="filterTier('A')" id="btn-A">ğŸ† Tier A</button>
      <button class="btn btn-sm btn-outline-primary" onclick="filterTier('B')" id="btn-B">âœ… Tier B</button>
      <button class="btn btn-sm btn-outline-warning" onclick="filterTier('C')" id="btn-C">â¬œ Tier C</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="filterTier('D')" id="btn-D" style="color:#fd7e14;border-color:#fd7e14">ğŸŸ  Tier D</button>
      <button class="btn btn-sm btn-outline-danger" onclick="filterTier('E')" id="btn-E">ğŸ”´ Tier E</button>
      <button class="btn btn-sm btn-outline-dark" onclick="filterTier('F')" id="btn-F">âš« Tier F</button>
      <div class="vr"></div>
      <span class="small text-muted" id="countLabel">Loadingâ€¦</span>
      <div class="vr"></div>
      <button id="satBtn" class="btn btn-sm btn-outline-secondary" onclick="toggleSatellite()">ğŸ›°ï¸ Satellite</button>
    </div>
  </div>
</div>

<div id="map" style="height: calc(100vh - 220px); border-radius: 0.5rem; overflow: hidden;"></div>

<!-- Legend -->
<div class="card border-0 shadow-sm mt-2">
  <div class="card-body py-2">
    <div class="d-flex gap-3 flex-wrap align-items-center">
      <span class="fw-semibold text-muted small">Legend:</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#198754;"></span> Tier A â€” Prime</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#0d6efd;"></span> Tier B â€” Good</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#ffc107;"></span> Tier C â€” Decent</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#fd7e14;"></span> Tier D â€” Marginal</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#dc3545;"></span> Tier E â€” Weak</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#212529;"></span> Tier F â€” Skip</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#dc3545;border:2px solid #9b1c1c;"></span> Wetland flagged</span>
      <span><span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#6c757d;"></span> Raw parcel</span>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>
const BASE = "{{ base_url }}";

const map = L.map('map').setView([47.9, -122.1], 10);

const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'Â© OpenStreetMap contributors'
});
const satelliteLayer = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution: 'Imagery Â© Esri' }
);
streetLayer.addTo(map);

let satActive = false;
function toggleSatellite() {
  if (satActive) {
    map.removeLayer(satelliteLayer);
    map.addLayer(streetLayer);
    document.getElementById('satBtn').textContent = 'ğŸ›°ï¸ Satellite';
    satActive = false;
  } else {
    map.removeLayer(streetLayer);
    map.addLayer(satelliteLayer);
    document.getElementById('satBtn').textContent = 'ğŸ—ºï¸ Street Map';
    satActive = true;
  }
}

let markers = [];
let currentTier = '';

function tierColor(tier, wetland) {
  if (wetland) return '#dc3545';
  if (tier === 'A') return '#198754';
  if (tier === 'B') return '#0d6efd';
  if (tier === 'C') return '#ffc107';
  if (tier === 'D') return '#fd7e14';
  if (tier === 'E') return '#dc3545';
  if (tier === 'F') return '#212529';
  if (tier === 'parcel') return '#6c757d';
  return '#6c757d';
}

function fmt(v) {
  return v ? '$' + Number(v).toLocaleString() : 'â€”';
}
function fmtSf(v) {
  if (!v) return 'â€”';
  return v.toLocaleString() + ' sf (' + (v/43560).toFixed(2) + ' ac)';
}

async function loadPoints(tier = '') {
  document.getElementById('countLabel').textContent = 'Loadingâ€¦';
  markers.forEach(m => map.removeLayer(m));
  markers = [];

  const url = `${BASE}/api/map/points${tier ? '?tier='+tier : ''}`;
  const pts = await fetch(url).then(r => r.json());

  document.getElementById('countLabel').textContent = `${pts.length.toLocaleString()} candidates shown`;

  pts.forEach(pt => {
    const color = tierColor(pt.tier, pt.wetland);
    const radius = pt.tier === 'A' ? 7 : pt.tier === 'B' ? 5 : 4;

    const marker = L.circleMarker([pt.lat, pt.lng], {
      radius,
      fillColor: color,
      color: pt.ag ? '#9b1c1c' : '#fff',
      weight: pt.ag ? 2 : 1,
      opacity: 0.9,
      fillOpacity: 0.85,
    });

    const flags = [
      pt.wetland ? 'ğŸŒ¿ Wetland overlap' : null,
      pt.ag ? 'ğŸšœ Agricultural zone' : null,
    ].filter(Boolean);

    marker.bindPopup(`
      <div style="min-width:200px">
        <div style="font-weight:700;font-size:1rem;margin-bottom:4px">${pt.address}</div>
        <div style="color:#555;margin-bottom:6px">${pt.owner || 'Unknown owner'}</div>
        <table style="width:100%;font-size:0.85rem;border-collapse:collapse">
          <tr><td style="color:#888">Tier</td><td><strong>Tier ${pt.tier}</strong></td></tr>
          <tr><td style="color:#888">Splits</td><td><strong style="color:#198754;font-size:1.1rem">${pt.splits ?? 'â€”'}</strong></td></tr>
          <tr><td style="color:#888">Lot Size</td><td>${fmtSf(pt.lot_sf)}</td></tr>
          <tr><td style="color:#888">Zone</td><td>${pt.zone || 'â€”'}</td></tr>
          <tr><td style="color:#888">Land Value</td><td>${fmt(pt.value)}</td></tr>
        </table>
        ${flags.length ? '<div style="margin-top:6px">' + flags.map(f=>`<span style="background:#fee2e2;color:#9b1c1c;padding:2px 6px;border-radius:4px;font-size:0.75rem;margin-right:4px">${f}</span>`).join('') + '</div>' : ''}
        <div style="margin-top:8px">
          <a href="${BASE}/candidates" style="font-size:0.8rem;color:#0d6efd">View all candidates â†’</a>
        </div>
      </div>
    `, { maxWidth: 280 });

    marker.addTo(map);
    markers.push(marker);
  });
}

function filterTier(tier) {
  currentTier = tier;
  ['all','A','B','C','D','E','F'].forEach(t => {
    const btn = document.getElementById('btn-' + t);
    if (btn) btn.className = btn.className.replace(' active','')
      .replace('btn-success','btn-outline-success')
      .replace('btn-primary','btn-outline-primary')
      .replace('btn-warning','btn-outline-warning')
      .replace('btn-danger','btn-outline-danger')
      .replace('btn-dark','btn-outline-dark');
  });
  const active = document.getElementById('btn-' + (tier || 'all'));
  if (active) {
    active.className = active.className
      .replace('btn-outline-success','btn-success')
      .replace('btn-outline-primary','btn-primary')
      .replace('btn-outline-warning','btn-warning')
      .replace('btn-outline-danger','btn-danger')
      .replace('btn-outline-dark','btn-dark') + ' active';
  }
  loadPoints(tier);
}

loadPoints();
</script>
{% endblock %}
