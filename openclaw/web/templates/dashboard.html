{% extends "base.html" %}
{% block title %}Dashboard ‚Äî Mike's BS{% endblock %}
{% block content %}
<div class="row g-3 mb-2">
  <div class="col-6 col-md-3">
    <div class="card text-center border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="display-6 fw-bold text-primary">{{ "{:,}".format(total_parcels) }}</div>
        <div class="text-muted small">Parcels Loaded</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="display-6 fw-bold text-success">{{ "{:,}".format(total_candidates) }}</div>
        <div class="text-muted small">Subdivision Candidates</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="display-6 fw-bold text-warning">{{ "{:,}".format(new_leads) }}</div>
        <div class="text-muted small">New Leads (7d)</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center border-0 shadow-sm h-100">
      <div class="card-body">
        <div class="display-6 fw-bold text-info">{{ "{:,}".format(total_leads) }}</div>
        <div class="text-muted small">Total Leads</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #198754 !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold text-success">{{ "{:,}".format(tier_a) }}</div>
        <div class="text-muted small">Tier A ‚Äî Prime</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #0d6efd !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold text-primary">{{ "{:,}".format(tier_b) }}</div>
        <div class="text-muted small">Tier B ‚Äî Good</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #ffc107 !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold text-warning">{{ "{:,}".format(tier_c) }}</div>
        <div class="text-muted small">Tier C ‚Äî Decent</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #fd7e14 !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold" style="color:#fd7e14">{{ "{:,}".format(tier_d) }}</div>
        <div class="text-muted small">Tier D ‚Äî Marginal</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #dc3545 !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold text-danger">{{ "{:,}".format(tier_e) }}</div>
        <div class="text-muted small">Tier E ‚Äî Weak</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-2">
    <div class="card text-center border-0 shadow-sm h-100" style="border-top: 4px solid #212529 !important;">
      <div class="card-body py-2">
        <div class="display-6 fw-bold text-dark">{{ "{:,}".format(tier_f) }}</div>
        <div class="text-muted small">Tier F ‚Äî Skip</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title fw-bold">Candidates by Tier</h6>
        <canvas id="tierChart" height="180"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card border-0 shadow-sm h-100">
      <div class="card-body">
        <h6 class="card-title fw-bold">üî• Top Tier A Deals</h6>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Address</th>
                <th>Owner</th>
                <th>Lot Size</th>
                <th>Splits</th>
                <th>Land Value</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for c in top5 %}
              <tr data-candidate-id='{{ c.id }}'>
                <td class="fw-semibold">{{ c.parcel.address or "‚Äî" }}</td>
                <td class="text-muted small">{{ c.parcel.owner_name or "‚Äî" }}</td>
                <td class="small">{{ c.parcel.lot_sf | acres }}</td>
                <td><span class="badge bg-success">{{ c.potential_splits }}</span></td>
                <td class="small">{{ c.estimated_land_value | money }}</td>
                <td><button class='btn btn-sm btn-outline-primary py-0' onclick='openCandidateModal("{{ c.id }}", "{{ c.parcel.id }}")'>Details</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-md-4">
    <a href="{{ base_url }}/candidates?tier=A" class="card text-decoration-none border-success border-2 h-100">
      <div class="card-body text-center py-4">
        <div class="fs-1">üèÜ</div>
        <div class="fs-4 fw-bold text-success">{{ "{:,}".format(tier_a) }} Tier A</div>
        <div class="text-muted">Best subdivision deals<br>4+ potential splits</div>
      </div>
    </a>
  </div>
  <div class="col-md-4">
    <a href="{{ base_url }}/candidates?tier=B" class="card text-decoration-none border-warning border-2 h-100">
      <div class="card-body text-center py-4">
        <div class="fs-1">‚úÖ</div>
        <div class="fs-4 fw-bold text-warning">{{ "{:,}".format(tier_b) }} Tier B</div>
        <div class="text-muted">Good subdivision deals<br>2‚Äì3 potential splits</div>
      </div>
    </a>
  </div>
  <div class="col-md-4">
    <a href="{{ base_url }}/map" class="card text-decoration-none border-primary border-2 h-100">
      <div class="card-body text-center py-4">
        <div class="fs-1">üó∫Ô∏è</div>
        <div class="fs-4 fw-bold text-primary">View Map</div>
        <div class="text-muted">See all candidates<br>plotted on the map</div>
      </div>
    </a>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="modalTitle">Candidate Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2" id="modalBody">
        <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<script>
new Chart(document.getElementById('tierChart'), {
  type: 'doughnut',
  data: {
    labels: ['Tier A', 'Tier B', 'Tier C', 'Tier D', 'Tier E', 'Tier F'],
    datasets: [{
      data: {{ tier_data_json }},
      backgroundColor: ['#198754','#0d6efd','#ffc107','#fd7e14','#dc3545','#212529'],
      borderWidth: 2,
    }]
  },
  options: { plugins: { legend: { position: 'bottom' } } }
});

const base_url = "{{ base_url }}";
const modal = new bootstrap.Modal(document.getElementById('detailModal'));
let _miniMap = null;

function fmt(v, prefix='$') {
  if (v == null) return '‚Äî';
  if (typeof v === 'number') return prefix + v.toLocaleString();
  return v;
}

function tierBadgeClass(tier) {
  const map = {A:'bg-success', B:'bg-primary', C:'bg-warning text-dark', D:'bg-orange text-white', E:'bg-danger', F:'bg-dark'};
  return map[tier] || 'bg-secondary';
}

function tierBadgeStyle(tier) {
  return tier === 'D' ? 'background:#fd7e14' : '';
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function submitFeedback(id, rating, category='', notes='') {
  const params = new URLSearchParams({rating});
  if (category) params.append('category', category);
  if (notes) params.append('notes', notes);
  await fetch(base_url + '/api/candidate/' + id + '/feedback?' + params, {method:'POST'});
}

async function loadNotes(id, limit=3) {
  return fetch(base_url + '/api/candidate/' + id + '/notes?limit=' + limit).then(r => r.json());
}

function clearTagFilters() {
  return;
}

async function openCandidateModal(id, parcelId='') {
  if (_miniMap) { _miniMap.remove(); _miniMap = null; }
  document.getElementById('modalTitle').textContent = 'Loading‚Ä¶';
  document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  modal.show();

  const [d, fb, notesData] = await Promise.all([
    fetch(base_url + '/api/candidate/' + id).then(r => r.json()),
    fetch(base_url + '/api/candidate/' + id + '/feedback').then(r => r.json()),
    loadNotes(id, 3),
  ]);

  const tierStyle = d.tier === 'D' ? 'style="background:#fd7e14"' : '';
  const tierCls = d.tier==='A'?'bg-success':d.tier==='B'?'bg-primary':d.tier==='C'?'bg-warning text-dark':d.tier==='D'?'':d.tier==='E'?'bg-danger':'bg-dark';

  document.getElementById('modalTitle').innerHTML =
    `<span class="badge ${tierCls} me-2" ${tierStyle}>Tier ${d.tier || '?'}</span>${d.address || 'No address'}`;

  const tagsHtml = (d.tags || []).map(t =>
    `<span class="badge me-1 mb-1" style="background:#e8f4fd;color:#0d6efd;border:1px solid #bee5fd">${t}</span>`
  ).join('');
  const sub = d.subdivision || null;
  const subBadgeCls = sub?.feasibility === 'LIKELY'
    ? 'bg-success'
    : (sub?.feasibility === 'POSSIBLE'
      ? 'bg-warning text-dark'
      : (sub?.feasibility === 'UNLIKELY' ? 'bg-danger' : 'bg-secondary'));
  const platMeta = sub?.plat_type === 'SHORT_PLAT'
    ? '<span class="badge bg-success-subtle text-success border border-success me-2">SHORT PLAT</span><span class="text-muted small">~3-6 months ¬∑ Admin approval</span>'
    : (sub?.plat_type === 'LONG_PLAT'
      ? '<span class="badge text-dark border me-2" style="background:#fff3cd;border-color:#ffda6a !important;">LONG PLAT</span><span class="text-muted small">2-3 years ¬∑ Full process</span>'
      : '<span class="badge bg-secondary">NOT FEASIBLE</span>');
  const subFlagsHtml = (sub?.flags || []).map(f =>
    `<span class="badge me-1 mb-1 ${f.startsWith('EDGE_') ? 'bg-success-subtle text-success border border-success' : (f.startsWith('RISK_') ? 'bg-danger-subtle text-danger border border-danger' : 'bg-light text-dark border')}">${escHtml(f)}</span>`
  ).join('');
  const subdivisionHtml = sub ? `
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üß≠ Subdivision Assessment</h6>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="badge ${subBadgeCls} px-2 py-1">${sub.feasibility || 'UNKNOWN'}</span>
          <span class="small text-muted">Feasible Splits: <span class="fw-semibold text-dark">${sub.feasible_splits ?? '‚Äî'}</span></span>
        </div>
        <div class="mb-2">${platMeta}</div>
        <div class="mb-2">
          <span class="${sub.sewer ? 'text-success' : 'text-warning'} small fw-semibold me-3">${sub.sewer ? '‚úÖ Sewer available' : '‚ö† Septic required'}</span>
          <span class="${sub.access ? 'text-success' : 'text-danger'} small fw-semibold">${sub.access ? '‚úÖ Access confirmed' : '‚ö† Access unknown'}</span>
        </div>
        <div class="small text-muted mb-1">Subdivision Score: <span class="fw-semibold text-dark">${sub.score ?? 0}</span>/100</div>
        <div class="progress" style="height:10px">
          <div class="progress-bar ${(sub.score ?? 0) >= 70 ? 'bg-success' : ((sub.score ?? 0) >= 40 ? 'bg-warning' : 'bg-danger')}" style="width:${Math.max(0, Math.min(100, sub.score ?? 0))}%"></div>
        </div>
        ${subFlagsHtml ? `<div class="mt-2">${subFlagsHtml}</div>` : ''}
      </div>` : '';

  const notesHtml = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';

  const upActive = fb.thumbs_up > 0 ? 'btn-success' : 'btn-outline-success';
  const downActive = fb.thumbs_down > 0 ? 'btn-danger' : 'btn-outline-danger';
  const detailUrl = `${base_url}/property/${d.parcel_id || parcelId || ''}`;

  document.getElementById('modalBody').innerHTML = `
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üìç Property</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Address</td><td class="fw-semibold">${d.address || '‚Äî'}</td></tr>
          <tr><td class="text-muted">County</td><td>${d.county || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Lot Size</td><td>${d.lot_sf ? d.lot_sf.toLocaleString() + ' sf<br><span class="text-muted">(' + d.lot_acres + ' ac)</span>' : '‚Äî'}</td></tr>
          <tr><td class="text-muted">Zone</td><td><strong>${d.zone_code || '‚Äî'}</strong>${d.zone_label ? '<br><span class="text-muted small">'+d.zone_label+'</span>' : ''}</td></tr>
          <tr><td class="text-muted">Use Code</td><td>${d.present_use || '‚Äî'}</td></tr>
          ${d.score != null ? `<tr><td class="text-muted">Score</td><td><span class="badge bg-secondary">${d.score} pts</span></td></tr>` : ''}
        </table>
      </div>

      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üë§ Owner</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Name</td><td class="fw-semibold">${d.owner_name || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Mailing</td><td class="small">${d.owner_address || '‚Äî'}</td></tr>
        </table>
        <h6 class="fw-bold text-muted text-uppercase small mb-2 mt-3">üí∞ Value</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Land Value</td><td>${fmt(d.assessed_value)}</td></tr>
          <tr><td class="text-muted">Improvements</td><td>${fmt(d.improvement_value)}</td></tr>
          <tr><td class="text-muted">Total Assessed</td><td class="fw-semibold">${fmt(d.total_value)}</td></tr>
        </table>
      </div>

      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üèóÔ∏è Subdivision Potential</h6>
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <div class="text-center p-3 rounded" style="background:#f0fdf4;min-width:80px">
              <div class="fs-2 fw-bold text-success">${d.splits ?? '‚Äî'}</div>
              <div class="small text-muted">Potential Splits</div>
            </div>
          </div>
          <div class="col">
            ${d.wetland_flag ? '<span class="badge bg-danger me-1 mb-1">üåø Wetland Overlap</span>' : ''}
            ${d.ag_flag ? '<span class="badge bg-warning text-dark me-1 mb-1">üöú Ag Zone</span>' : ''}
            ${d.shoreline_flag ? '<span class="badge bg-info me-1 mb-1">üåä Shoreline</span>' : ''}
            ${!d.wetland_flag && !d.ag_flag && !d.shoreline_flag ? '<span class="text-success small">‚úÖ No critical area flags</span>' : ''}
            ${tagsHtml ? '<div class="mt-2">'+tagsHtml+'</div>' : ''}
          </div>
        </div>
      </div>

      ${subdivisionHtml}

      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üõ∞Ô∏è Satellite View</h6>
        ${d.lat ? `
        <div id="minimap-${d.id}" style="height:200px;border-radius:8px;overflow:hidden;margin-bottom:8px"></div>
        <div class="d-flex gap-2 flex-wrap">
          <a href="https://www.google.com/maps/@${d.lat},${d.lng},18z/data=!3m1!1e3" target="_blank" class="btn btn-sm btn-outline-secondary">üìç Google Maps</a>
          <a href="https://earth.google.com/web/@${d.lat},${d.lng},500a,500d,35y,0h,0t,0r" target="_blank" class="btn btn-sm btn-outline-secondary">üåç Google Earth</a>
        </div>` : '<span class="text-muted small">No coordinates available</span>'}
      </div>

      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">‚≠ê Rating</h6>
        <div class="d-flex gap-2 align-items-center mb-2">
          <button id="upBtn-${d.id}" class="btn btn-sm ${upActive}" onclick="doRating('${d.id}','up')">
            üëç <span id="upCount-${d.id}">${fb.thumbs_up}</span>
          </button>
          <button id="downBtn-${d.id}" class="btn btn-sm ${downActive}" onclick="doRating('${d.id}','down')">
            üëé <span id="downCount-${d.id}">${fb.thumbs_down}</span>
          </button>
        </div>
        <div id="fbForm-${d.id}" class="d-none mb-2">
          <select id="fbCat-${d.id}" class="form-select form-select-sm mb-1" style="max-width:320px">
            <option value="">Select reason‚Ä¶</option>
            <option value="wrong_use">Wrong use type (substation, commercial, etc.)</option>
            <option value="utility">Utility / govt owned</option>
            <option value="hoa">HOA / association land</option>
            <option value="not_buildable">Not buildable (wetland, access issue)</option>
            <option value="other">Other</option>
          </select>
          <textarea id="fbNotes-${d.id}" class="form-control form-control-sm mb-1" rows="2" placeholder="Notes (optional)‚Ä¶" style="max-width:320px"></textarea>
          <button class="btn btn-danger btn-sm" onclick="submitNegFeedback('${d.id}')">Save note (optional)</button>
        </div>
      </div>

      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üí¨ Notes</h6>
        <div id="notesList-${d.id}" class="mb-2">${notesHtml}</div>
        <div class="d-flex gap-2">
          <input id="noteInput-${d.id}" type="text" class="form-control form-control-sm" placeholder="Add a note‚Ä¶" style="max-width:300px"
                 onkeydown="if(event.key==='Enter'){addNote('${d.id}')}">
          <button class="btn btn-sm btn-outline-primary" onclick="addNote('${d.id}')">Add note</button>
        </div>
      </div>

      <div class="col-12 border-top pt-3 d-flex justify-content-end">
        <a href="${detailUrl}" class="btn btn-primary btn-sm">View Full Details ‚Üí</a>
      </div>
    </div>
  `;

  if (d.lat) {
    setTimeout(() => {
      _miniMap = L.map(`minimap-${d.id}`, {zoomControl: false, attributionControl: false})
        .setView([d.lat, d.lng], 17);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(_miniMap);
      L.marker([d.lat, d.lng]).addTo(_miniMap);
    }, 300);
  }
}

async function doRating(id, rating, listItemSelector=null) {
  const resp = await fetch(`${base_url}/api/candidate/${id}/feedback`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({feedback_type: rating === 'up' ? 'thumbs_up' : 'thumbs_down'})
  });
  await resp.json();

  if (rating === 'down') {
    const row = document.querySelector(listItemSelector || `tr[data-candidate-id='${id}']`);
    if (row) {
      row.style.transition = 'opacity 0.4s';
      row.style.opacity = '0';
      setTimeout(() => row.remove(), 400);
    }
    try { bootstrap.Modal.getInstance(document.getElementById('detailModal') || document.getElementById('candidateModal'))?.hide(); } catch(e) {}
    try { bootstrap.Modal.getInstance(document.getElementById('propertyModal'))?.hide(); } catch(e) {}
    const fbDiv = document.getElementById('fbForm-'+id);
    if (fbDiv) { fbDiv.classList.remove('d-none'); }
  } else {
    const upBtn = document.getElementById('upBtn-'+id);
    if (upBtn) upBtn.className = 'btn btn-sm btn-success';
  }
}

async function submitNegFeedback(id) {
  const catEl = document.getElementById(`fbCat-${id}`);
  const notesEl = document.getElementById(`fbNotes-${id}`);
  const cat = catEl ? catEl.value : '';
  const notes = notesEl ? notesEl.value.trim() : '';
  const reasonMap = {
    wrong_use: 'Wrong use type',
    utility: 'Utility / govt owned',
    hoa: 'HOA / association land',
    not_buildable: 'Not buildable',
    other: 'Other'
  };
  const parts = [];
  if (cat) parts.push(`Downvote reason: ${reasonMap[cat] || cat}`);
  if (notes) parts.push(notes);
  if (!parts.length) {
    document.getElementById(`fbForm-${id}`).innerHTML = '<span class="text-muted small">No note saved.</span>';
    return;
  }
  await fetch(`${base_url}/api/candidate/${id}/notes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note: parts.join(' | ')}),
  });
  document.getElementById(`fbForm-${id}`).innerHTML = '<span class="text-success small">‚úÖ Note saved</span>';
}

async function addNote(id) {
  const inp = document.getElementById(`noteInput-${id}`);
  const note = inp.value.trim();
  if (!note) return;
  await fetch(base_url + '/api/candidate/' + id + '/notes', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note}),
  });
  inp.value = '';
  const notesData = await loadNotes(id, 3);
  const html = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';
  document.getElementById(`notesList-${id}`).innerHTML = html;
}
</script>
{% endblock %}
