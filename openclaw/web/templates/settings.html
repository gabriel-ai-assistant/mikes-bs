{% extends "base.html" %}
{% block title %}Settings ‚Äî Mike's BS{% endblock %}
{% block content %}

<!-- Re-score Panel -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <h5 class="fw-bold mb-1">üîÑ Re-score Candidates</h5>
        <p class="text-muted mb-0 small">Apply your current rules to all 23,620 candidates. Preview first to see what changes.</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary" onclick="previewRescore()">üëÅ Preview</button>
        <button class="btn btn-primary" onclick="runRescore()">‚ñ∂ Apply Rules Now</button>
      </div>
    </div>
    <div id="rescoreResult" class="mt-3 d-none">
      <div class="row g-2" id="tierPreview"></div>
    </div>
  </div>
</div>

<!-- Tier legend -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <h5 class="fw-bold mb-3">üìä Tier Legend</h5>
    <div class="row g-2">
      <div class="col-6 col-md-2"><div class="p-2 rounded text-white text-center fw-bold" style="background:#198754">A ‚Äî Prime</div></div>
      <div class="col-6 col-md-2"><div class="p-2 rounded text-white text-center fw-bold" style="background:#0d6efd">B ‚Äî Good</div></div>
      <div class="col-6 col-md-2"><div class="p-2 rounded text-dark text-center fw-bold" style="background:#ffc107">C ‚Äî Decent</div></div>
      <div class="col-6 col-md-2"><div class="p-2 rounded text-white text-center fw-bold" style="background:#fd7e14">D ‚Äî Marginal</div></div>
      <div class="col-6 col-md-2"><div class="p-2 rounded text-white text-center fw-bold" style="background:#dc3545">E ‚Äî Weak</div></div>
      <div class="col-6 col-md-2"><div class="p-2 rounded text-white text-center fw-bold" style="background:#212529">F ‚Äî Skip</div></div>
    </div>
  </div>
</div>

<!-- Add Rule Form -->
<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">
    <h5 class="fw-bold mb-3">‚ûï Add Scoring Rule</h5>
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label small fw-semibold">Rule Name</label>
        <input type="text" id="rName" class="form-control" placeholder="e.g. Mobile Home Park">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small fw-semibold">Field</label>
        <select id="rField" class="form-select">
          <option value="present_use">Use Code</option>
          <option value="owner_name">Owner Name</option>
          <option value="zone_code">Zone Code</option>
          <option value="lot_sf">Lot Size (sf)</option>
          <option value="has_wetland">Has Wetland</option>
          <option value="has_ag">Has Ag Zone</option>
          <option value="improvement_value">Improvement Value</option>
          <option value="total_value">Total Value</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small fw-semibold">Operator</label>
        <select id="rOperator" class="form-select">
          <option value="contains">contains</option>
          <option value="eq">equals</option>
          <option value="neq">does not equal</option>
          <option value="not_contains">does not contain</option>
          <option value="gt">greater than</option>
          <option value="lt">less than</option>
          <option value="gte">‚â•</option>
          <option value="lte">‚â§</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small fw-semibold">Value</label>
        <input type="text" id="rValue" class="form-control" placeholder="e.g. Mobile Home">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label small fw-semibold">Action</label>
        <select id="rAction" class="form-select" onchange="updateActionUI()">
          <option value="set_tier">Set Tier</option>
          <option value="adjust_score">Adjust Score</option>
          <option value="exclude">Exclude</option>
          <option value="flag">Flag Only</option>
        </select>
      </div>
      <div class="col-6 col-md-1" id="tierSelect">
        <label class="form-label small fw-semibold">Tier</label>
        <select id="rTier" class="form-select">
          <option value="A">A</option>
          <option value="B">B</option>
          <option value="C">C</option>
          <option value="D">D</option>
          <option value="E">E</option>
          <option value="F" selected>F</option>
        </select>
      </div>
      <div class="col-6 col-md-1 d-none" id="scoreAdjInput">
        <label class="form-label small fw-semibold">Points</label>
        <input type="number" id="rScoreAdj" class="form-control" value="-10" placeholder="¬±pts">
      </div>
      <div class="col-6 col-md-1">
        <label class="form-label small fw-semibold">Priority</label>
        <input type="number" id="rPriority" class="form-control" value="100">
      </div>
      <div class="col-12 col-md-1">
        <label class="form-label small fw-semibold">&nbsp;</label>
        <button class="btn btn-success w-100" onclick="addRule()">Add</button>
      </div>
    </div>
    <div id="addRuleMsg" class="mt-2"></div>
  </div>
</div>

<!-- Rules Table -->
<div class="card border-0 shadow-sm">
  <div class="card-body">
    <h5 class="fw-bold mb-3">üìã Active Rules <span class="badge bg-secondary" id="ruleCount">‚Ä¶</span></h5>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>Priority</th>
            <th>Rule Name</th>
            <th>Condition</th>
            <th>Action</th>
            <th>Active</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="rulesBody">
          <tr><td colspan="6" class="text-center text-muted py-3">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const BASE = "{{ base_url }}";

const TIER_COLORS = {A:'#198754',B:'#0d6efd',C:'#ffc107',D:'#fd7e14',E:'#dc3545',F:'#212529'};
const FIELD_LABELS = {
  present_use:'Use Code', owner_name:'Owner Name', zone_code:'Zone Code',
  lot_sf:'Lot Size', has_wetland:'Has Wetland', has_ag:'Has Ag Zone',
  improvement_value:'Improvement Value', total_value:'Total Value'
};
const OP_LABELS = {
  eq:'=', neq:'‚â†', contains:'contains', not_contains:'not contains',
  gt:'>', lt:'<', gte:'‚â•', lte:'‚â§'
};

function updateActionUI() {
  const action = document.getElementById('rAction').value;
  document.getElementById('tierSelect').classList.toggle('d-none', action !== 'set_tier');
  document.getElementById('scoreAdjInput').classList.toggle('d-none', action !== 'adjust_score');
}

function actionBadge(action, tier, scoreAdj) {
  if (action === 'set_tier') {
    const color = TIER_COLORS[tier] || '#666';
    return `<span class="badge" style="background:${color}">‚Üí Tier ${tier}</span>`;
  }
  if (action === 'adjust_score') {
    const sign = scoreAdj >= 0 ? '+' : '';
    const color = scoreAdj >= 0 ? '#198754' : '#dc3545';
    return `<span class="badge" style="background:${color}">${sign}${scoreAdj} pts</span>`;
  }
  if (action === 'exclude') return '<span class="badge bg-dark">‚õî Exclude</span>';
  return '<span class="badge bg-secondary">üö© Flag</span>';
}

async function loadRules() {
  const rules = await fetch(`${BASE}/api/rules`).then(r => r.json());
  document.getElementById('ruleCount').textContent = rules.length;
  const tbody = document.getElementById('rulesBody');
  if (!rules.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No rules yet. Add one above.</td></tr>';
    return;
  }
  tbody.innerHTML = rules.map(r => `
    <tr class="${r.active ? '' : 'table-secondary opacity-50'}">
      <td><span class="badge bg-secondary">${r.priority}</span></td>
      <td class="fw-semibold">${r.name}</td>
      <td class="small">
        <span class="text-muted">${FIELD_LABELS[r.field] || r.field}</span>
        <strong class="mx-1">${OP_LABELS[r.operator] || r.operator}</strong>
        <code>${r.value}</code>
      </td>
      <td>${actionBadge(r.action, r.tier, r.score_adj)}</td>
      <td>
        <div class="form-check form-switch mb-0">
          <input class="form-check-input" type="checkbox" ${r.active ? 'checked' : ''}
            onchange="toggleRule('${r.id}', this)">
        </div>
      </td>
      <td>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteRule('${r.id}', this)">üóë</button>
      </td>
    </tr>
  `).join('');
}

async function toggleRule(id, checkbox) {
  await fetch(`${BASE}/api/rules/${id}/toggle`, {method:'PATCH'});
  loadRules();
}

async function deleteRule(id, btn) {
  if (!confirm('Delete this rule?')) return;
  btn.disabled = true;
  await fetch(`${BASE}/api/rules/${id}`, {method:'DELETE'});
  loadRules();
}

async function addRule() {
  const action = document.getElementById('rAction').value;
  const body = {
    name: document.getElementById('rName').value.trim(),
    field: document.getElementById('rField').value,
    operator: document.getElementById('rOperator').value,
    value: document.getElementById('rValue').value.trim(),
    action,
    tier: action === 'set_tier' ? document.getElementById('rTier').value : null,
    score_adj: action === 'adjust_score' ? parseInt(document.getElementById('rScoreAdj').value) : 0,
    priority: parseInt(document.getElementById('rPriority').value) || 100,
  };
  if (!body.name || !body.value) {
    document.getElementById('addRuleMsg').innerHTML = '<span class="text-danger small">Name and Value are required.</span>';
    return;
  }
  await fetch(`${BASE}/api/rules`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  document.getElementById('addRuleMsg').innerHTML = '<span class="text-success small">‚úÖ Rule added!</span>';
  document.getElementById('rName').value = '';
  document.getElementById('rValue').value = '';
  setTimeout(() => document.getElementById('addRuleMsg').innerHTML = '', 3000);
  loadRules();
}

async function previewRescore() {
  const btn = event.target;
  btn.disabled = true; btn.textContent = '‚è≥ Previewing‚Ä¶';
  const data = await fetch(`${BASE}/api/rescore/preview`).then(r => r.json());
  btn.disabled = false; btn.textContent = 'üëÅ Preview';

  const preview = data.preview || {};
  document.getElementById('rescoreResult').classList.remove('d-none');
  document.getElementById('tierPreview').innerHTML = Object.entries(preview).map(([tier, cnt]) => `
    <div class="col-4 col-md-2">
      <div class="p-3 rounded text-center text-white fw-bold" style="background:${TIER_COLORS[tier] || '#666'}">
        <div class="fs-4">${cnt.toLocaleString()}</div>
        <div class="small">Tier ${tier}</div>
      </div>
    </div>
  `).join('') + `<div class="col-12 col-md-3"><div class="p-3 rounded text-center bg-light fw-semibold">
    <div class="fs-5 text-danger">${data.excluded.toLocaleString()}</div>
    <div class="small text-muted">Will be excluded</div>
  </div></div><div class="col-12 small text-muted mt-1">${data.rules_active} active rules. Click "Apply Rules Now" to commit.</div>`;
}

async function runRescore() {
  if (!confirm('Re-score all candidates now? This will update all tier assignments.')) return;
  const btn = event.target;
  btn.disabled = true; btn.textContent = '‚è≥ Re-scoring‚Ä¶';
  const data = await fetch(`${BASE}/api/rescore`, {method:'POST'}).then(r => r.json());
  btn.disabled = false; btn.textContent = '‚ñ∂ Apply Rules Now';

  const tiers = data.tiers || {};
  const total = Object.values(tiers).reduce((a,b) => a+b, 0);
  document.getElementById('rescoreResult').classList.remove('d-none');
  document.getElementById('tierPreview').innerHTML = Object.entries(tiers).map(([tier, cnt]) => `
    <div class="col-4 col-md-2">
      <div class="p-3 rounded text-center text-white fw-bold" style="background:${TIER_COLORS[tier] || '#666'}">
        <div class="fs-4">${cnt.toLocaleString()}</div>
        <div class="small">Tier ${tier}</div>
      </div>
    </div>
  `).join('') + `<div class="col-12 small text-success mt-1">‚úÖ Done! ${total.toLocaleString()} candidates re-scored, ${data.excluded} excluded.</div>`;
}

// Load on page open
loadRules();
</script>
{% endblock %}
