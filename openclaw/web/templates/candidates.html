{% extends "base.html" %}
{% block title %}Candidates â€” Mike's BS{% endblock %}
{% block content %}

<!-- Filters -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <input type="text" name="q" class="form-control" placeholder="Search address or owner nameâ€¦" value="{{ search }}">
      </div>
      <div class="col-6 col-md-2">
        <select name="tier" class="form-select">
          <option value="">All Tiers</option>
          <option value="A" {% if tier=='A' %}selected{% endif %}>ğŸ† Tier A</option>
          <option value="B" {% if tier=='B' %}selected{% endif %}>âœ… Tier B</option>
          <option value="C" {% if tier=='C' %}selected{% endif %}>â¬œ Tier C</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <select name="sort" class="form-select">
          <option value="splits" {% if sort=='splits' %}selected{% endif %}>Most Splits</option>
          <option value="lot" {% if sort=='lot' %}selected{% endif %}>Largest Lot</option>
          <option value="value" {% if sort=='value' %}selected{% endif %}>Highest Value</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <div class="form-check form-switch pt-2">
          <input class="form-check-input" type="checkbox" name="ag" value="1" id="agCheck" {% if ag=='1' %}checked{% endif %}>
          <label class="form-check-label small" for="agCheck">Ag Zone Only</label>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <span class="text-muted small">Showing {{ candidates|length }} results</span>
  <a href="{{ base_url }}/map" class="btn btn-sm btn-outline-secondary">ğŸ—ºï¸ View on Map</a>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" id="candidateTable">
      <thead class="table-dark">
        <tr>
          <th>Tier</th>
          <th>Address</th>
          <th>Owner</th>
          <th>Owner Mailing</th>
          <th>Lot Size</th>
          <th>Zone</th>
          <th>Splits</th>
          <th>Land Value</th>
          <th>Flags</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for c in candidates %}
        {% set p = c.parcel %}
        <tr>
          <td>
            {% if c.score_tier and c.score_tier.value == 'A' %}
              <span class="badge bg-success fs-6">A</span>
            {% elif c.score_tier and c.score_tier.value == 'B' %}
              <span class="badge bg-warning text-dark fs-6">B</span>
            {% else %}
              <span class="badge bg-secondary fs-6">C</span>
            {% endif %}
          </td>
          <td class="fw-semibold">{{ p.address or "â€”" }}</td>
          <td>{{ p.owner_name or "â€”" }}</td>
          <td class="text-muted small">{{ p.owner_address or "â€”" }}</td>
          <td class="small text-nowrap">
            {{ p.lot_sf | sqft }}<br>
            <span class="text-muted">{{ p.lot_sf | acres }}</span>
          </td>
          <td class="small">
            <span class="badge bg-light text-dark border">{{ p.zone_code or "â€”" }}</span>
            {% if p.zone_code and zone_labels.get(p.zone_code) %}
            <div class="text-muted" style="font-size:0.7rem">{{ zone_labels[p.zone_code] | truncate(30) }}</div>
            {% endif %}
          </td>
          <td class="text-center fw-bold fs-5">{{ c.potential_splits or "â€”" }}</td>
          <td class="small">{{ c.estimated_land_value | money }}</td>
          <td class="small">
            {% if c.has_critical_area_overlap %}<span class="badge bg-danger" title="Wetland overlap">ğŸŒ¿ Wetland</span>{% endif %}
            {% if c.flagged_for_review %}<span class="badge bg-warning text-dark" title="Ag notification zone">ğŸšœ Ag Zone</span>{% endif %}
          </td>
          <td>
            <button class="btn btn-sm btn-outline-primary"
                    onclick="showDetail('{{ c.id }}')" title="View Details">
              Details
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if not candidates %}
        <tr><td colspan="10" class="text-center text-muted py-4">No candidates match your filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Candidate Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const BASE = "{{ base_url }}";
const modal = new bootstrap.Modal(document.getElementById('detailModal'));

function fmt(v, prefix='$') {
  if (v == null) return 'â€”';
  if (typeof v === 'number') return prefix + v.toLocaleString();
  return v;
}

async function showDetail(id) {
  document.getElementById('modalTitle').textContent = 'Loadingâ€¦';
  document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  modal.show();
  const d = await fetch(`${BASE}/api/candidate/${id}`).then(r => r.json());
  document.getElementById('modalTitle').innerHTML =
    `<span class="badge ${d.tier==='A'?'bg-success':d.tier==='B'?'bg-warning text-dark':'bg-secondary'} me-2">Tier ${d.tier}</span>${d.address || 'No address'}`;

  document.getElementById('modalBody').innerHTML = `
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-1">ğŸ“ Property</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted">Address</td><td class="fw-semibold">${d.address || 'â€”'}</td></tr>
          <tr><td class="text-muted">County</td><td>${d.county || 'â€”'}</td></tr>
          <tr><td class="text-muted">Lot Size</td><td>${d.lot_sf ? d.lot_sf.toLocaleString() + ' sf (' + d.lot_acres + ' ac)' : 'â€”'}</td></tr>
          <tr><td class="text-muted">Zone</td><td><strong>${d.zone_code || 'â€”'}</strong>${d.zone_label ? '<br><span class="text-muted small">'+d.zone_label+'</span>' : ''}</td></tr>
          <tr><td class="text-muted">Use Code</td><td>${d.present_use || 'â€”'}</td></tr>
        </table>
      </div>
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-1">ğŸ‘¤ Owner</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted">Name</td><td class="fw-semibold">${d.owner_name || 'â€”'}</td></tr>
          <tr><td class="text-muted">Mailing</td><td>${d.owner_address || 'â€”'}</td></tr>
        </table>
        <h6 class="fw-bold text-muted text-uppercase small mb-1 mt-3">ğŸ’° Value</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted">Land Value</td><td>${fmt(d.assessed_value)}</td></tr>
          <tr><td class="text-muted">Improvements</td><td>${fmt(d.improvement_value)}</td></tr>
          <tr><td class="text-muted">Total Assessed</td><td class="fw-semibold">${fmt(d.total_value)}</td></tr>
        </table>
      </div>
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-1">ğŸ—ï¸ Subdivision Potential</h6>
        <div class="row g-2">
          <div class="col-4 text-center p-2 bg-light rounded">
            <div class="fs-3 fw-bold text-success">${d.splits}</div>
            <div class="small text-muted">Potential Splits</div>
          </div>
          <div class="col-8">
            ${d.wetland_flag ? '<span class="badge bg-danger me-1">ğŸŒ¿ Wetland Overlap</span>' : ''}
            ${d.ag_flag ? '<span class="badge bg-warning text-dark me-1">ğŸšœ Ag Zone</span>' : ''}
            ${d.shoreline_flag ? '<span class="badge bg-info me-1">ğŸŒŠ Shoreline</span>' : ''}
            ${!d.wetland_flag && !d.ag_flag && !d.shoreline_flag ? '<span class="text-success small">âœ… No critical area flags</span>' : ''}
          </div>
        </div>
      </div>
    </div>
  `;
}
</script>
{% endblock %}
