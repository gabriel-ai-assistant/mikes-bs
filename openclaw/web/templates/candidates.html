{% extends "base.html" %}
{% block title %}Candidates ‚Äî Mike's BS{% endblock %}
{% block content %}
{% set chip_map = {
  'RISK_WIDTH_CONSTRAINED': 'Width ‚ö†',
  'RISK_ACCESS_TRACT_REQUIRED': 'Shared Access',
  'RISK_ARV_MARGIN_THIN': 'Thin Margin ‚ö†',
  'RISK_ECON_LOSS_AT_ASK': 'Loss at Ask ‚ùå',
  'RISK_INFILL_PRICED_IN': 'Priced In',
  'EDGE_ARBITRAGE_DEPTH_HIGH': 'Deep Arbitrage üéØ'
} %}

<!-- Filters -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" id="filterForm" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <input type="text" name="q" class="form-control" placeholder="Search address or owner name‚Ä¶" value="{{ search }}">
      </div>
      <div class="col-6 col-md-2">
        <select name="tier" class="form-select">
          <option value="">All Tiers</option>
          <option value="A" {% if tier=='A' %}selected{% endif %}>üèÜ Tier A</option>
          <option value="B" {% if tier=='B' %}selected{% endif %}>‚úÖ Tier B</option>
          <option value="C" {% if tier=='C' %}selected{% endif %}>‚¨ú Tier C</option>
          <option value="D" {% if tier=='D' %}selected{% endif %}>üü† Tier D</option>
          <option value="E" {% if tier=='E' %}selected{% endif %}>üî¥ Tier E</option>
          <option value="F" {% if tier=='F' %}selected{% endif %}>‚ö´ Tier F</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <select name="sort" class="form-select">
          <option value="splits" {% if sort=='splits' %}selected{% endif %}>Most Splits</option>
          <option value="lot" {% if sort=='lot' %}selected{% endif %}>Largest Lot</option>
          <option value="value" {% if sort=='value' %}selected{% endif %}>Highest Value</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <div class="form-check form-switch pt-2">
          <input class="form-check-input" type="checkbox" name="ag" value="1" id="agCheck" {% if ag=='1' %}checked{% endif %}>
          <label class="form-check-label small" for="agCheck">Ag Zone Only</label>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
      <!-- Hidden inputs for tag filter (managed by JS below) -->
      <input type="hidden" name="tags" id="hiddenTags" value="{{ tags }}">
      <input type="hidden" name="tags_mode" id="hiddenTagsMode" value="{{ tags_mode }}">
    </form>
  </div>
</div>

<!-- Tag / Flags Filter Bar -->
<div class="card border-0 shadow-sm mb-3" id="tagFilterCard">
  <div class="card-body py-2">
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <span class="fw-semibold small text-muted text-uppercase" style="letter-spacing:.04em">üè∑Ô∏è Flags</span>

      <!-- Tag dropdown trigger -->
      <div class="dropdown" id="tagDropdownWrapper">
        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="tagDropdownBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
          <span id="tagDropdownLabel">Select tags‚Ä¶</span>
        </button>
        <div class="dropdown-menu p-2 shadow" style="min-width:280px;max-height:320px;overflow-y:auto" id="tagDropdownMenu">
          <div class="text-muted small text-center py-2" id="tagLoadingMsg">Loading‚Ä¶</div>
        </div>
      </div>

      <!-- Match mode toggle -->
      <div class="btn-group btn-group-sm" role="group" id="matchModeGroup">
        <input type="radio" class="btn-check" name="matchMode" id="modeAny" autocomplete="off" checked>
        <label class="btn btn-outline-secondary" for="modeAny">Match ANY</label>
        <input type="radio" class="btn-check" name="matchMode" id="modeAll" autocomplete="off">
        <label class="btn btn-outline-secondary" for="modeAll">Match ALL</label>
      </div>

      <!-- Apply / Clear -->
      <button class="btn btn-sm btn-primary" id="applyTagsBtn" onclick="applyTagFilter()">Apply</button>
      <button class="btn btn-sm btn-outline-secondary" id="clearTagsBtn" onclick="clearTagFilter()">Clear</button>
    </div>

    <!-- Active filter chips -->
    <div id="activeTagChips" class="mt-2 d-flex flex-wrap gap-1"></div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <span class="text-muted small" id="resultCount">Showing <strong>{{ candidates|length }}</strong> results</span>
  <a href="{{ base_url }}/map" class="btn btn-sm btn-outline-secondary">üó∫Ô∏è View on Map</a>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" id="candidateTable">
      <thead class="table-dark">
        <tr>
          <th>Tier</th>
          <th>Address</th>
          <th>Owner</th>
          <th>Owner Mailing</th>
          <th>Lot Size</th>
          <th>Zone</th>
          <th>Splits</th>
          <th>Land Value</th>
          <th>Flags</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for c in candidates %}
        {% set p = c.parcel %}
        <tr data-candidate-id='{{ c.id }}' data-parcel-id='{{ p.id }}' style="cursor:pointer" onclick="openCandidateModal('{{ c.id }}', '{{ p.id }}')" title="Click to view details">
          <td>
            {% if c.score_tier and c.score_tier.value == 'A' %}
              <span class="badge bg-success fs-6">A</span>
            {% elif c.score_tier and c.score_tier.value == 'B' %}
              <span class="badge bg-primary fs-6">B</span>
            {% elif c.score_tier and c.score_tier.value == 'C' %}
              <span class="badge bg-warning text-dark fs-6">C</span>
            {% elif c.score_tier and c.score_tier.value == 'D' %}
              <span class="badge fs-6 text-white" style="background:#fd7e14">D</span>
            {% elif c.score_tier and c.score_tier.value == 'E' %}
              <span class="badge bg-danger fs-6">E</span>
            {% elif c.score_tier and c.score_tier.value == 'F' %}
              <span class="badge bg-dark fs-6">F</span>
            {% else %}
              <span class="badge bg-secondary fs-6">?</span>
            {% endif %}
          </td>
          <td class="fw-semibold">{{ p.address or "‚Äî" }}</td>
          <td>{{ p.owner_name or "‚Äî" }}</td>
          <td class="text-muted small">{{ p.owner_address or "‚Äî" }}</td>
          <td class="small text-nowrap">
            {{ p.lot_sf | sqft }}<br>
            <span class="text-muted">{{ p.lot_sf | acres }}</span>
          </td>
          <td class="small">
            <span class="badge bg-light text-dark border">{{ p.zone_code or "‚Äî" }}</span>
            {% if p.zone_code and zone_labels.get(p.zone_code) %}
            <div class="text-muted" style="font-size:0.7rem">{{ zone_labels[p.zone_code] | truncate(30) }}</div>
            {% endif %}
          </td>
          <td class="text-center">
            <div class="fw-bold fs-5">{{ c.potential_splits or "‚Äî" }}</div>
            {% if c.splits_min is not none and c.splits_max is not none %}
            <div class="small text-muted">{{ c.splits_min }}-{{ c.splits_max }}</div>
            {% endif %}
            {% if c.splits_confidence %}
            <span class="badge {% if c.splits_confidence == 'HIGH' %}conf-badge-high{% elif c.splits_confidence == 'MEDIUM' %}conf-badge-medium{% else %}conf-badge-low{% endif %}">
              {{ c.splits_confidence }}
            </span>
            {% endif %}
          </td>
          <td class="small">{{ c.estimated_land_value | money }}</td>
          <td class="small">
            {% if c.has_critical_area_overlap %}<span class="badge bg-danger" title="Wetland overlap">üåø Wetland</span>{% endif %}
            {% if c.flagged_for_review %}<span class="badge bg-warning text-dark" title="Ag notification zone">üöú Ag Zone</span>{% endif %}
            {% for t in c.tags or [] %}
              {% if chip_map.get(t) %}<span class="badge bg-secondary">{{ chip_map[t] }}</span>{% endif %}
            {% endfor %}
            {% for t in c.subdivision_flags or [] %}
              {% if chip_map.get(t) %}<span class="badge bg-secondary">{{ chip_map[t] }}</span>{% endif %}
            {% endfor %}
          </td>
          <td>
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary py-0"
                      onclick="event.stopPropagation(); openCandidateModal('{{ c.id }}', '{{ p.id }}')" title="Details">Details</button>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not candidates %}
        <tr><td colspan="10" class="text-center text-muted py-4">No candidates match your filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="modalTitle">Candidate Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2" id="modalBody">
        <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>

// ‚îÄ‚îÄ Tag Filter Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BASE = "{{ base_url }}";

// Parse current tags from server-rendered value
let _selectedTags = new Set(
  "{{ tags }}".split(",").map(t => t.trim()).filter(t => t.length > 0)
);
let _allTagData = [];

function tagColor(tag) {
  if (tag.startsWith('EDGE_')) return {bg:'#d1fae5',text:'#065f46',border:'#6ee7b7'};
  if (tag.startsWith('RISK_')) return {bg:'#fee2e2',text:'#991b1b',border:'#fca5a5'};
  return {bg:'#f3f4f6',text:'#374151',border:'#d1d5db'};
}

function renderChips() {
  const container = document.getElementById('activeTagChips');
  if (!container) return;
  container.innerHTML = '';
  _selectedTags.forEach(tag => {
    const c = tagColor(tag);
    const chip = document.createElement('span');
    chip.className = 'badge d-inline-flex align-items-center gap-1 px-2 py-1';
    chip.style.cssText = `background:${c.bg};color:${c.text};border:1px solid ${c.border};font-size:.75rem;cursor:default`;
    chip.innerHTML = `${escHtml(tag)} <button type="button" class="btn-close" style="font-size:.5rem;filter:none" aria-label="Remove" onclick="removeTag('${escHtml(tag)}')"></button>`;
    container.appendChild(chip);
  });
  // Update dropdown label
  const btn = document.getElementById('tagDropdownLabel');
  if (btn) btn.textContent = _selectedTags.size > 0 ? `${_selectedTags.size} tag(s) selected` : 'Select tags\u2026';
}

function removeTag(tag) {
  _selectedTags.delete(tag);
  renderChips();
  renderDropdownItems();
}

function renderDropdownItems() {
  const menu = document.getElementById('tagDropdownMenu');
  if (!menu) return;
  menu.innerHTML = '';
  if (_allTagData.length === 0) {
    menu.innerHTML = '<div class="text-muted small text-center py-2">No tags available</div>';
    return;
  }
  const groups = [
    { prefix: 'EDGE_', label: 'EDGE tags', color: 'text-success' },
    { prefix: 'RISK_', label: 'RISK tags', color: 'text-danger' },
    { prefix: '',      label: 'Other tags', color: 'text-secondary' },
  ];
  let rendered = new Set();
  groups.forEach(({prefix, label, color}) => {
    const items = _allTagData.filter(t =>
      prefix ? t.tag.startsWith(prefix)
             : !t.tag.startsWith('EDGE_') && !t.tag.startsWith('RISK_')
    );
    if (items.length === 0) return;
    const hdr = document.createElement('div');
    hdr.className = `dropdown-header small fw-bold ${color} py-1`;
    hdr.textContent = label;
    menu.appendChild(hdr);
    items.forEach(({tag, count}) => {
      if (rendered.has(tag)) return;
      rendered.add(tag);
      const item = document.createElement('label');
      item.className = 'd-flex align-items-center gap-2 px-2 py-1 rounded';
      item.style.cssText = 'cursor:pointer;font-size:.82rem';
      item.onmouseenter = () => item.style.background = '#f8f9fa';
      item.onmouseleave = () => item.style.background = '';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = tag;
      cb.checked = _selectedTags.has(tag);
      cb.className = 'form-check-input me-1';
      cb.addEventListener('change', () => {
        if (cb.checked) _selectedTags.add(tag);
        else _selectedTags.delete(tag);
        renderChips();
      });
      const tagSpan = document.createElement('span');
      const c = tagColor(tag);
      tagSpan.innerHTML = `<span class="badge" style="background:${c.bg};color:${c.text};border:1px solid ${c.border};font-size:.72rem">${escHtml(tag)}</span>`;
      const cntSpan = document.createElement('span');
      cntSpan.className = 'text-muted ms-auto';
      cntSpan.style.fontSize = '.75rem';
      cntSpan.textContent = count.toLocaleString();
      item.appendChild(cb);
      item.appendChild(tagSpan);
      item.appendChild(cntSpan);
      menu.appendChild(item);
    });
    const divider = document.createElement('div');
    divider.className = 'dropdown-divider my-1';
    menu.appendChild(divider);
  });
}

async function loadTags() {
  try {
    const data = await fetch(`${BASE}/api/tags`).then(r => r.json());
    _allTagData = data;
    const loadMsg = document.getElementById('tagLoadingMsg');
    if (loadMsg) loadMsg.remove();
    renderDropdownItems();
    renderChips();
  } catch(e) {
    const msg = document.getElementById('tagLoadingMsg');
    if (msg) msg.textContent = 'Failed to load tags';
  }
}

function applyTagFilter() {
  document.getElementById('hiddenTags').value = Array.from(_selectedTags).join(',');
  document.getElementById('hiddenTagsMode').value = document.getElementById('modeAll').checked ? 'all' : 'any';
  document.getElementById('filterForm').submit();
}

function clearTagFilter() {
  _selectedTags.clear();
  renderChips();
  renderDropdownItems();
  document.getElementById('hiddenTags').value = '';
  document.getElementById('hiddenTagsMode').value = 'any';
  document.getElementById('filterForm').submit();
}

// Restore match mode from current URL param
(function() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('tags_mode') === 'all') {
    document.getElementById('modeAll').checked = true;
  }
})();

// Load tags on page load
loadTags();

// ‚îÄ‚îÄ Original script globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const modal = new bootstrap.Modal(document.getElementById('detailModal'));

// Remove downvoted row when modal is dismissed
document.getElementById('detailModal').addEventListener('hidden.bs.modal', () => {
  if (window._lastDownvotedId) {
    const row = document.querySelector(`tr[data-candidate-id='${window._lastDownvotedId}']`);
    if (row) {
      row.style.transition = 'opacity 0.5s';
      row.style.opacity = '0';
      setTimeout(() => row.remove(), 500);
    }
    window._lastDownvotedId = null;
  }
});

let _miniMap = null;

function fmt(v, prefix='$') {
  if (v == null) return '‚Äî';
  if (typeof v === 'number') return prefix + v.toLocaleString();
  return v;
}

function tierBadgeClass(tier) {
  const map = {A:'bg-success', B:'bg-primary', C:'bg-warning text-dark', D:'bg-orange text-white', E:'bg-danger', F:'bg-dark'};
  return map[tier] || 'bg-secondary';
}
function tierBadgeStyle(tier) {
  return tier === 'D' ? 'background:#fd7e14' : '';
}
function confBadgeClass(conf) {
  if (conf === 'HIGH') return 'conf-badge-high';
  if (conf === 'MEDIUM') return 'conf-badge-medium';
  return 'conf-badge-low';
}
const TAG_LABELS = {
  RISK_WIDTH_CONSTRAINED: 'Width ‚ö†',
  RISK_ACCESS_TRACT_REQUIRED: 'Shared Access',
  RISK_ARV_MARGIN_THIN: 'Thin Margin ‚ö†',
  RISK_ECON_LOSS_AT_ASK: 'Loss at Ask ‚ùå',
  RISK_INFILL_PRICED_IN: 'Priced In',
  EDGE_ARBITRAGE_DEPTH_HIGH: 'Deep Arbitrage üéØ',
};
function chipText(tag) {
  return TAG_LABELS[tag] || tag;
}

async function submitFeedback(id, rating, category='', notes='') {
  const params = new URLSearchParams({rating});
  if (category) params.append('category', category);
  if (notes) params.append('notes', notes);
  await fetch(`${BASE}/api/candidate/${id}/feedback?${params}`, {method:'POST'});
}

async function openCandidateModal(id, parcelId='') {
  if (_miniMap) { _miniMap.remove(); _miniMap = null; }
  document.getElementById('modalTitle').textContent = 'Loading‚Ä¶';
  document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  modal.show();

  const [d, fb, notesData] = await Promise.all([
    fetch(`${BASE}/api/candidate/${id}`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/feedback`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r => r.json()),
  ]);

  const tierStyle = d.tier === 'D' ? 'style="background:#fd7e14"' : '';
  const tierCls = d.tier==='A'?'bg-success':d.tier==='B'?'bg-primary':d.tier==='C'?'bg-warning text-dark':d.tier==='D'?'':d.tier==='E'?'bg-danger':'bg-dark';

  document.getElementById('modalTitle').innerHTML =
    `<span class="badge ${tierCls} me-2" ${tierStyle}>Tier ${d.tier || '?'}</span>${d.address || 'No address'}`;

  const tagsHtml = (d.tags || []).map(t =>
    `<span class="badge me-1 mb-1" style="background:#e8f4fd;color:#0d6efd;border:1px solid #bee5fd">${chipText(escHtml(t))}</span>`
  ).join('');
  const sub = d.subdivision || null;
  const subBadgeCls = sub?.feasibility === 'LIKELY'
    ? 'bg-success'
    : (sub?.feasibility === 'POSSIBLE'
      ? 'bg-warning text-dark'
      : (sub?.feasibility === 'UNLIKELY' ? 'bg-danger' : 'bg-secondary'));
  const platMeta = sub?.plat_type === 'SHORT_PLAT'
    ? '<span class="badge bg-success-subtle text-success border border-success me-2">SHORT PLAT</span><span class="text-muted small">~3-6 months ¬∑ Admin approval</span>'
    : (sub?.plat_type === 'LONG_PLAT'
      ? '<span class="badge text-dark border me-2" style="background:#fff3cd;border-color:#ffda6a !important;">LONG PLAT</span><span class="text-muted small">2-3 years ¬∑ Full process</span>'
      : '<span class="badge bg-secondary">NOT FEASIBLE</span>');
  const subFlagsHtml = (sub?.flags || []).map(f =>
    `<span class="badge me-1 mb-1 ${f.startsWith('EDGE_') ? 'bg-success-subtle text-success border border-success' : (f.startsWith('RISK_') ? 'bg-danger-subtle text-danger border border-danger' : 'bg-light text-dark border')}">${chipText(escHtml(f))}</span>`
  ).join('');
  const subdivisionHtml = sub ? `
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üß≠ Subdivision Assessment</h6>
        <div class="d-flex align-items-center justify-content-between mb-2">
          <span class="badge ${subBadgeCls} px-2 py-1">${sub.feasibility || 'UNKNOWN'}</span>
          <span class="small text-muted">Splits Range: <span class="fw-semibold text-dark">${sub.splits_min ?? '‚Äî'}-${sub.splits_max ?? '‚Äî'}</span></span>
        </div>
        <div class="mb-2">
          ${sub.splits_confidence ? `<span class="badge ${confBadgeClass(sub.splits_confidence)}">${sub.splits_confidence}</span>` : ''}
          ${sub.access_mode ? `<span class="badge bg-secondary ms-1">${sub.access_mode}</span>` : ''}
        </div>
        <div class="mb-2">${platMeta}</div>
        <div class="mb-2">
          <span class="${sub.sewer ? 'text-success' : 'text-warning'} small fw-semibold me-3">${sub.sewer ? '‚úÖ Sewer available' : '‚ö† Septic required'}</span>
          <span class="${sub.access ? 'text-success' : 'text-danger'} small fw-semibold">${sub.access ? '‚úÖ Access confirmed' : '‚ö† Access unknown'}</span>
        </div>
        <div class="small text-muted mb-2">
          Econ Margin: <span class="fw-semibold text-dark">${sub.economic_margin_pct == null ? '‚Äî' : (sub.economic_margin_pct * 100).toFixed(1) + '%'}</span>
          ¬∑ Arbitrage: <span class="fw-semibold text-dark">${sub.arbitrage_depth_score ?? '‚Äî'}</span>
        </div>
        <div class="small text-muted mb-1">Subdivision Score: <span class="fw-semibold text-dark">${sub.score ?? 0}</span>/100</div>
        <div class="progress" style="height:10px">
          <div class="progress-bar ${(sub.score ?? 0) >= 70 ? 'bg-success' : ((sub.score ?? 0) >= 40 ? 'bg-warning' : 'bg-danger')}" style="width:${Math.max(0, Math.min(100, sub.score ?? 0))}%"></div>
        </div>
        ${subFlagsHtml ? `<div class="mt-2">${subFlagsHtml}</div>` : ''}
      </div>` : '';

  const notesHtml = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';

  const upActive   = fb.thumbs_up > 0 ? 'btn-success' : 'btn-outline-success';
  const downActive = fb.thumbs_down > 0 ? 'btn-danger' : 'btn-outline-danger';

  const detailUrl = `${BASE}/property/${d.parcel_id || parcelId || ''}`;

  document.getElementById('modalBody').innerHTML = `
    <div class="row g-3">

      <!-- Property Info -->
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üìç Property</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Address</td><td class="fw-semibold">${d.address || '‚Äî'}</td></tr>
          <tr><td class="text-muted">County</td><td>${d.county || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Lot Size</td><td>${d.lot_sf ? d.lot_sf.toLocaleString() + ' sf<br><span class="text-muted">(' + d.lot_acres + ' ac)</span>' : '‚Äî'}</td></tr>
          <tr><td class="text-muted">Zone</td><td><strong>${d.zone_code || '‚Äî'}</strong>${d.zone_label ? '<br><span class="text-muted small">'+d.zone_label+'</span>' : ''}</td></tr>
          <tr><td class="text-muted">Use Code</td><td>${d.present_use || '‚Äî'}</td></tr>
          ${d.score != null ? `<tr><td class="text-muted">Score</td><td><span class="badge bg-secondary">${d.score} pts</span></td></tr>` : ''}
        </table>
      </div>

      <!-- Owner + Value -->
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üë§ Owner</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Name</td><td class="fw-semibold">${d.owner_name || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Mailing</td><td class="small">${d.owner_address || '‚Äî'}</td></tr>
        </table>
        <h6 class="fw-bold text-muted text-uppercase small mb-2 mt-3">üí∞ Value</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Land Value</td><td>${fmt(d.assessed_value)}</td></tr>
          <tr><td class="text-muted">Improvements</td><td>${fmt(d.improvement_value)}</td></tr>
          <tr><td class="text-muted">Total Assessed</td><td class="fw-semibold">${fmt(d.total_value)}</td></tr>
        </table>
      </div>

      <!-- Splits + Flags -->
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üèóÔ∏è Subdivision Potential</h6>
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <div class="text-center p-3 rounded" style="background:#f0fdf4;min-width:80px">
              <div class="fs-2 fw-bold text-success">${d.splits ?? '‚Äî'}</div>
              <div class="small text-muted">${d.splits_min ?? '‚Äî'}-${d.splits_max ?? '‚Äî'}</div>
              ${d.splits_confidence ? `<div><span class="badge ${confBadgeClass(d.splits_confidence)}">${d.splits_confidence}</span></div>` : ''}
            </div>
          </div>
          <div class="col">
            ${d.wetland_flag ? '<span class="badge bg-danger me-1 mb-1">üåø Wetland Overlap</span>' : ''}
            ${d.ag_flag ? '<span class="badge bg-warning text-dark me-1 mb-1">üöú Ag Zone</span>' : ''}
            ${d.shoreline_flag ? '<span class="badge bg-info me-1 mb-1">üåä Shoreline</span>' : ''}
            ${!d.wetland_flag && !d.ag_flag && !d.shoreline_flag ? '<span class="text-success small">‚úÖ No critical area flags</span>' : ''}
            ${tagsHtml ? '<div class="mt-2">'+tagsHtml+'</div>' : ''}
          </div>
        </div>
      </div>

      ${subdivisionHtml}

      <!-- Satellite -->
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üõ∞Ô∏è Satellite View</h6>
        ${d.lat ? `
        <div id="minimap-${d.id}" style="height:200px;border-radius:8px;overflow:hidden;margin-bottom:8px"></div>
        <div class="d-flex gap-2 flex-wrap">
          <a href="https://www.google.com/maps/?q=${d.lat},${d.lng}" target="_blank" class="btn btn-sm btn-outline-secondary">üìç Google Maps</a>
          <a href="https://earth.google.com/web/@${d.lat},${d.lng},500a,500d,35y,0h,0t,0r" target="_blank" class="btn btn-sm btn-outline-secondary">üåç Google Earth</a>
        </div>` : '<span class="text-muted small">No coordinates available</span>'}
      </div>

      <!-- Rating + Feedback -->
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">‚≠ê Rating</h6>
        <div class="d-flex gap-2 align-items-center mb-2">
          <button id="upBtn-${d.id}" class="btn btn-sm ${upActive}" onclick="doRating('${d.id}','up')">
            üëç <span id="upCount-${d.id}">${fb.thumbs_up}</span>
          </button>
          <button id="downBtn-${d.id}" class="btn btn-sm ${downActive}" onclick="doRating('${d.id}','down')">
            üëé <span id="downCount-${d.id}">${fb.thumbs_down}</span>
          </button>
        </div>
        <!-- Negative feedback reason (hidden until üëé clicked) -->
        <div id="fbForm-${d.id}" class="d-none mb-2">
          <select id="fbCat-${d.id}" class="form-select form-select-sm mb-1" style="max-width:320px">
            <option value="">Select reason‚Ä¶</option>
            <option value="wrong_use">Wrong use type (substation, commercial, etc.)</option>
            <option value="utility">Utility / govt owned</option>
            <option value="hoa">HOA / association land</option>
            <option value="not_buildable">Not buildable (wetland, access issue)</option>
            <option value="other">Other</option>
          </select>
          <textarea id="fbNotes-${d.id}" class="form-control form-control-sm mb-1" rows="2" placeholder="Notes (optional)‚Ä¶" style="max-width:320px"></textarea>
          <button class="btn btn-danger btn-sm" onclick="submitNegFeedback('${d.id}')">Save note (optional)</button>
        </div>
      </div>

      <!-- Comments -->
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üí¨ Notes</h6>
        <div id="notesList-${d.id}" class="mb-2">${notesHtml}</div>
        <div class="d-flex gap-2">
          <input id="noteInput-${d.id}" type="text" class="form-control form-control-sm" placeholder="Add a note‚Ä¶" style="max-width:300px"
                 onkeydown="if(event.key==='Enter'){addNote('${d.id}')}">
          <button class="btn btn-sm btn-outline-primary" onclick="addNote('${d.id}')">Add note</button>
        </div>
      </div>

      <!-- View Details -->
      <div class="col-12 border-top pt-3 d-flex justify-content-end">
        <a href="${detailUrl}" class="btn btn-primary btn-sm">View Full Details ‚Üí</a>
      </div>

    </div>
  `;

  if (d.lat) {
    setTimeout(() => {
      _miniMap = L.map(`minimap-${d.id}`, {zoomControl: false, attributionControl: false})
        .setView([d.lat, d.lng], 17);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(_miniMap);
      L.marker([d.lat, d.lng]).addTo(_miniMap);
    }, 300);
  }
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function doRating(id, rating, listItemSelector=null) {
  const resp = await fetch(`${BASE}/api/candidate/${id}/feedback`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({feedback_type: rating === 'up' ? 'thumbs_up' : 'thumbs_down'})
  });
  await resp.json();

  if (rating === 'down') {
    // Store candidate id ‚Äî row removed when modal closes
    window._lastDownvotedId = id;
    const downBtn = document.getElementById('downBtn-'+id);
    if (downBtn) downBtn.className = 'btn btn-sm btn-danger';
    // Show reason/note form ‚Äî modal stays open
    const fbDiv = document.getElementById('fbForm-'+id);
    if (fbDiv) { fbDiv.classList.remove('d-none'); }
  } else {
    const upBtn = document.getElementById('upBtn-'+id);
    if (upBtn) upBtn.className = 'btn btn-sm btn-success';
  }
}

async function submitNegFeedback(id) {
  const catEl = document.getElementById(`fbCat-${id}`);
  const notesEl = document.getElementById(`fbNotes-${id}`);
  const cat = catEl ? catEl.value : '';
  const notes = notesEl ? notesEl.value.trim() : '';
  const reasonMap = {
    wrong_use: 'Wrong use type',
    utility: 'Utility / govt owned',
    hoa: 'HOA / association land',
    not_buildable: 'Not buildable',
    other: 'Other'
  };
  const parts = [];
  if (cat) parts.push(`Downvote reason: ${reasonMap[cat] || cat}`);
  if (notes) parts.push(notes);
  if (!parts.length) {
    document.getElementById(`fbForm-${id}`).innerHTML = '<span class="text-muted small">No note saved.</span>';
    return;
  }
  await fetch(`${BASE}/api/candidate/${id}/notes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note: parts.join(' | ')}),
  });
  document.getElementById(`fbForm-${id}`).innerHTML = '<span class="text-success small">‚úÖ Note saved</span>';
}

async function addNote(id) {
  const inp = document.getElementById(`noteInput-${id}`);
  const note = inp.value.trim();
  if (!note) return;
  await fetch(`${BASE}/api/candidate/${id}/notes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note}),
  });
  inp.value = '';
  // Reload notes
  const notesData = await fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r=>r.json());
  const html = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';
  document.getElementById(`notesList-${id}`).innerHTML = html;
}
</script>
{% endblock %}
