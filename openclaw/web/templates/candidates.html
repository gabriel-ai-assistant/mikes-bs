{% extends "base.html" %}
{% block title %}Candidates â€” Mike's BS{% endblock %}
{% block content %}

<!-- Filters -->
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <input type="text" name="q" class="form-control" placeholder="Search address or owner nameâ€¦" value="{{ search }}">
      </div>
      <div class="col-6 col-md-2">
        <select name="tier" class="form-select">
          <option value="">All Tiers</option>
          <option value="A" {% if tier=='A' %}selected{% endif %}>ğŸ† Tier A</option>
          <option value="B" {% if tier=='B' %}selected{% endif %}>âœ… Tier B</option>
          <option value="C" {% if tier=='C' %}selected{% endif %}>â¬œ Tier C</option>
          <option value="D" {% if tier=='D' %}selected{% endif %}>ğŸŸ  Tier D</option>
          <option value="E" {% if tier=='E' %}selected{% endif %}>ğŸ”´ Tier E</option>
          <option value="F" {% if tier=='F' %}selected{% endif %}>âš« Tier F</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <select name="sort" class="form-select">
          <option value="splits" {% if sort=='splits' %}selected{% endif %}>Most Splits</option>
          <option value="lot" {% if sort=='lot' %}selected{% endif %}>Largest Lot</option>
          <option value="value" {% if sort=='value' %}selected{% endif %}>Highest Value</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <div class="form-check form-switch pt-2">
          <input class="form-check-input" type="checkbox" name="ag" value="1" id="agCheck" {% if ag=='1' %}checked{% endif %}>
          <label class="form-check-label small" for="agCheck">Ag Zone Only</label>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <span class="text-muted small">Showing {{ candidates|length }} results</span>
  <a href="{{ base_url }}/map" class="btn btn-sm btn-outline-secondary">ğŸ—ºï¸ View on Map</a>
</div>

<!-- Table -->
<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" id="candidateTable">
      <thead class="table-dark">
        <tr>
          <th>Tier</th>
          <th>Address</th>
          <th>Owner</th>
          <th>Owner Mailing</th>
          <th>Lot Size</th>
          <th>Zone</th>
          <th>Splits</th>
          <th>Land Value</th>
          <th>Flags</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for c in candidates %}
        {% set p = c.parcel %}
        <tr>
          <td>
            {% if c.score_tier and c.score_tier.value == 'A' %}
              <span class="badge bg-success fs-6">A</span>
            {% elif c.score_tier and c.score_tier.value == 'B' %}
              <span class="badge bg-primary fs-6">B</span>
            {% elif c.score_tier and c.score_tier.value == 'C' %}
              <span class="badge bg-warning text-dark fs-6">C</span>
            {% elif c.score_tier and c.score_tier.value == 'D' %}
              <span class="badge fs-6 text-white" style="background:#fd7e14">D</span>
            {% elif c.score_tier and c.score_tier.value == 'E' %}
              <span class="badge bg-danger fs-6">E</span>
            {% elif c.score_tier and c.score_tier.value == 'F' %}
              <span class="badge bg-dark fs-6">F</span>
            {% else %}
              <span class="badge bg-secondary fs-6">?</span>
            {% endif %}
          </td>
          <td class="fw-semibold">{{ p.address or "â€”" }}</td>
          <td>{{ p.owner_name or "â€”" }}</td>
          <td class="text-muted small">{{ p.owner_address or "â€”" }}</td>
          <td class="small text-nowrap">
            {{ p.lot_sf | sqft }}<br>
            <span class="text-muted">{{ p.lot_sf | acres }}</span>
          </td>
          <td class="small">
            <span class="badge bg-light text-dark border">{{ p.zone_code or "â€”" }}</span>
            {% if p.zone_code and zone_labels.get(p.zone_code) %}
            <div class="text-muted" style="font-size:0.7rem">{{ zone_labels[p.zone_code] | truncate(30) }}</div>
            {% endif %}
          </td>
          <td class="text-center fw-bold fs-5">{{ c.potential_splits or "â€”" }}</td>
          <td class="small">{{ c.estimated_land_value | money }}</td>
          <td class="small">
            {% if c.has_critical_area_overlap %}<span class="badge bg-danger" title="Wetland overlap">ğŸŒ¿ Wetland</span>{% endif %}
            {% if c.flagged_for_review %}<span class="badge bg-warning text-dark" title="Ag notification zone">ğŸšœ Ag Zone</span>{% endif %}
          </td>
          <td>
            <div class="d-flex gap-1">
              <button class="btn btn-sm btn-outline-primary"
                      onclick="showDetail('{{ c.id }}')" title="View Details">Details</button>
            </div>
          </td>
        </tr>
        {% endfor %}
        {% if not candidates %}
        <tr><td colspan="10" class="text-center text-muted py-4">No candidates match your filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="modalTitle">Candidate Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2" id="modalBody">
        <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>
const BASE = "{{ base_url }}";
const modal = new bootstrap.Modal(document.getElementById('detailModal'));
let _miniMap = null;

function fmt(v, prefix='$') {
  if (v == null) return 'â€”';
  if (typeof v === 'number') return prefix + v.toLocaleString();
  return v;
}

function tierBadgeClass(tier) {
  const map = {A:'bg-success', B:'bg-primary', C:'bg-warning text-dark', D:'bg-orange text-white', E:'bg-danger', F:'bg-dark'};
  return map[tier] || 'bg-secondary';
}
function tierBadgeStyle(tier) {
  return tier === 'D' ? 'background:#fd7e14' : '';
}

async function submitFeedback(id, rating, category='', notes='') {
  const params = new URLSearchParams({rating});
  if (category) params.append('category', category);
  if (notes) params.append('notes', notes);
  await fetch(`${BASE}/api/candidate/${id}/feedback?${params}`, {method:'POST'});
}

async function showDetail(id) {
  if (_miniMap) { _miniMap.remove(); _miniMap = null; }
  document.getElementById('modalTitle').textContent = 'Loadingâ€¦';
  document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  modal.show();

  const [d, fb, notesData] = await Promise.all([
    fetch(`${BASE}/api/candidate/${id}`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/feedback`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r => r.json()),
  ]);

  const tierStyle = d.tier === 'D' ? 'style="background:#fd7e14"' : '';
  const tierCls = d.tier==='A'?'bg-success':d.tier==='B'?'bg-primary':d.tier==='C'?'bg-warning text-dark':d.tier==='D'?'':d.tier==='E'?'bg-danger':'bg-dark';

  document.getElementById('modalTitle').innerHTML =
    `<span class="badge ${tierCls} me-2" ${tierStyle}>Tier ${d.tier || '?'}</span>${d.address || 'No address'}`;

  const tagsHtml = (d.tags || []).map(t =>
    `<span class="badge me-1 mb-1" style="background:#e8f4fd;color:#0d6efd;border:1px solid #bee5fd">${t}</span>`
  ).join('');

  const notesHtml = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">ğŸ’¬</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';

  const upActive   = fb.thumbs_up > 0 ? 'btn-success' : 'btn-outline-success';
  const downActive = fb.thumbs_down > 0 ? 'btn-danger' : 'btn-outline-danger';

  const detailUrl = `${BASE}/property/${d.parcel_id || ''}`;

  document.getElementById('modalBody').innerHTML = `
    <div class="row g-3">

      <!-- Property Info -->
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">ğŸ“ Property</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Address</td><td class="fw-semibold">${d.address || 'â€”'}</td></tr>
          <tr><td class="text-muted">County</td><td>${d.county || 'â€”'}</td></tr>
          <tr><td class="text-muted">Lot Size</td><td>${d.lot_sf ? d.lot_sf.toLocaleString() + ' sf<br><span class="text-muted">(' + d.lot_acres + ' ac)</span>' : 'â€”'}</td></tr>
          <tr><td class="text-muted">Zone</td><td><strong>${d.zone_code || 'â€”'}</strong>${d.zone_label ? '<br><span class="text-muted small">'+d.zone_label+'</span>' : ''}</td></tr>
          <tr><td class="text-muted">Use Code</td><td>${d.present_use || 'â€”'}</td></tr>
          ${d.score != null ? `<tr><td class="text-muted">Score</td><td><span class="badge bg-secondary">${d.score} pts</span></td></tr>` : ''}
        </table>
      </div>

      <!-- Owner + Value -->
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">ğŸ‘¤ Owner</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Name</td><td class="fw-semibold">${d.owner_name || 'â€”'}</td></tr>
          <tr><td class="text-muted">Mailing</td><td class="small">${d.owner_address || 'â€”'}</td></tr>
        </table>
        <h6 class="fw-bold text-muted text-uppercase small mb-2 mt-3">ğŸ’° Value</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Land Value</td><td>${fmt(d.assessed_value)}</td></tr>
          <tr><td class="text-muted">Improvements</td><td>${fmt(d.improvement_value)}</td></tr>
          <tr><td class="text-muted">Total Assessed</td><td class="fw-semibold">${fmt(d.total_value)}</td></tr>
        </table>
      </div>

      <!-- Splits + Flags -->
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">ğŸ—ï¸ Subdivision Potential</h6>
        <div class="row g-2 align-items-center">
          <div class="col-auto">
            <div class="text-center p-3 rounded" style="background:#f0fdf4;min-width:80px">
              <div class="fs-2 fw-bold text-success">${d.splits ?? 'â€”'}</div>
              <div class="small text-muted">Potential Splits</div>
            </div>
          </div>
          <div class="col">
            ${d.wetland_flag ? '<span class="badge bg-danger me-1 mb-1">ğŸŒ¿ Wetland Overlap</span>' : ''}
            ${d.ag_flag ? '<span class="badge bg-warning text-dark me-1 mb-1">ğŸšœ Ag Zone</span>' : ''}
            ${d.shoreline_flag ? '<span class="badge bg-info me-1 mb-1">ğŸŒŠ Shoreline</span>' : ''}
            ${!d.wetland_flag && !d.ag_flag && !d.shoreline_flag ? '<span class="text-success small">âœ… No critical area flags</span>' : ''}
            ${tagsHtml ? '<div class="mt-2">'+tagsHtml+'</div>' : ''}
          </div>
        </div>
      </div>

      <!-- Satellite -->
      <div class="col-12">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">ğŸ›°ï¸ Satellite View</h6>
        ${d.lat ? `
        <div id="minimap-${d.id}" style="height:200px;border-radius:8px;overflow:hidden;margin-bottom:8px"></div>
        <div class="d-flex gap-2 flex-wrap">
          <a href="https://www.google.com/maps/@${d.lat},${d.lng},18z/data=!3m1!1e3" target="_blank" class="btn btn-sm btn-outline-secondary">ğŸ“ Google Maps</a>
          <a href="https://earth.google.com/web/@${d.lat},${d.lng},500a,500d,35y,0h,0t,0r" target="_blank" class="btn btn-sm btn-outline-secondary">ğŸŒ Google Earth</a>
        </div>` : '<span class="text-muted small">No coordinates available</span>'}
      </div>

      <!-- Rating + Feedback -->
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">â­ Rating</h6>
        <div class="d-flex gap-2 align-items-center mb-2">
          <button id="upBtn-${d.id}" class="btn btn-sm ${upActive}" onclick="doRating('${d.id}','up')">
            ğŸ‘ <span id="upCount-${d.id}">${fb.thumbs_up}</span>
          </button>
          <button id="downBtn-${d.id}" class="btn btn-sm ${downActive}" onclick="doRating('${d.id}','down')">
            ğŸ‘ <span id="downCount-${d.id}">${fb.thumbs_down}</span>
          </button>
        </div>
        <!-- Negative feedback reason (hidden until ğŸ‘ clicked) -->
        <div id="fbForm-${d.id}" class="d-none mb-2">
          <select id="fbCat-${d.id}" class="form-select form-select-sm mb-1" style="max-width:320px">
            <option value="">Select reasonâ€¦</option>
            <option value="wrong_use">Wrong use type (substation, commercial, etc.)</option>
            <option value="utility">Utility / govt owned</option>
            <option value="hoa">HOA / association land</option>
            <option value="not_buildable">Not buildable (wetland, access issue)</option>
            <option value="other">Other</option>
          </select>
          <textarea id="fbNotes-${d.id}" class="form-control form-control-sm mb-1" rows="2" placeholder="Notes (optional)â€¦" style="max-width:320px"></textarea>
          <button class="btn btn-danger btn-sm" onclick="submitNegFeedback('${d.id}')">Submit</button>
        </div>
      </div>

      <!-- Comments -->
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">ğŸ’¬ Notes</h6>
        <div id="notesList-${d.id}" class="mb-2">${notesHtml}</div>
        <div class="d-flex gap-2">
          <input id="noteInput-${d.id}" type="text" class="form-control form-control-sm" placeholder="Add a noteâ€¦" style="max-width:300px"
                 onkeydown="if(event.key==='Enter'){addNote('${d.id}')}">
          <button class="btn btn-sm btn-outline-primary" onclick="addNote('${d.id}')">Add note</button>
        </div>
      </div>

      <!-- View Details -->
      <div class="col-12 border-top pt-3 d-flex justify-content-end">
        <a href="${detailUrl}" class="btn btn-primary btn-sm">View Full Details â†’</a>
      </div>

    </div>
  `;

  if (d.lat) {
    setTimeout(() => {
      _miniMap = L.map(`minimap-${d.id}`, {zoomControl: false, attributionControl: false})
        .setView([d.lat, d.lng], 17);
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(_miniMap);
      L.marker([d.lat, d.lng]).addTo(_miniMap);
    }, 300);
  }
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

async function doRating(id, rating) {
  const params = new URLSearchParams({rating});
  await fetch(`${BASE}/api/candidate/${id}/feedback?${params}`, {method:'POST'});
  // Reload counts
  const fb = await fetch(`${BASE}/api/candidate/${id}/feedback`).then(r=>r.json());
  document.getElementById(`upCount-${id}`).textContent = fb.thumbs_up;
  document.getElementById(`downCount-${id}`).textContent = fb.thumbs_down;
  if (rating === 'up') {
    document.getElementById(`upBtn-${id}`).className = 'btn btn-sm btn-success';
    document.getElementById(`fbForm-${id}`).classList.add('d-none');
  } else {
    document.getElementById(`downBtn-${id}`).className = 'btn btn-sm btn-danger';
    document.getElementById(`fbForm-${id}`).classList.remove('d-none');
  }
}

async function submitNegFeedback(id) {
  const cat = document.getElementById(`fbCat-${id}`).value;
  const notes = document.getElementById(`fbNotes-${id}`).value;
  const params = new URLSearchParams({rating:'down'});
  if (cat) params.append('category', cat);
  if (notes) params.append('notes', notes);
  await fetch(`${BASE}/api/candidate/${id}/feedback?${params}`, {method:'POST'});
  document.getElementById(`fbForm-${id}`).innerHTML = '<span class="text-success small">âœ… Feedback saved</span>';
}

async function addNote(id) {
  const inp = document.getElementById(`noteInput-${id}`);
  const note = inp.value.trim();
  if (!note) return;
  await fetch(`${BASE}/api/candidate/${id}/notes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note}),
  });
  inp.value = '';
  // Reload notes
  const notesData = await fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r=>r.json());
  const html = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">ğŸ’¬</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';
  document.getElementById(`notesList-${id}`).innerHTML = html;
}
</script>
{% endblock %}
