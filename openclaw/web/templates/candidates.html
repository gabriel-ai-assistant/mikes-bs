{% extends "base.html" %}
{% block title %}Candidates ‚Äî Mike's BS{% endblock %}
{% block content %}
{% set chip_map = {
  'RISK_WIDTH_CONSTRAINED': 'Width ‚ö†',
  'RISK_ACCESS_TRACT_REQUIRED': 'Shared Access',
  'RISK_ARV_MARGIN_THIN': 'Thin Margin ‚ö†',
  'RISK_ECON_LOSS_AT_ASK': 'Loss at Ask ‚ùå',
  'RISK_INFILL_PRICED_IN': 'Priced In',
  'EDGE_ARBITRAGE_DEPTH_HIGH': 'Deep Arbitrage üéØ'
} %}

<style>
  .vote-btn {
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .filter-chip {
    border: 1px solid #dee2e6;
    border-radius: 999px;
    padding: 2px 10px;
    font-size: 0.78rem;
    background: #f8f9fa;
  }
  .column-chooser {
    min-width: 320px;
    max-width: 380px;
  }
  @media (max-width: 767px) {
    .column-chooser {
      display: none;
    }
  }
</style>

<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-2">
    <form method="get" id="filterForm" class="row g-2 align-items-end">
      <input type="hidden" name="page" id="pageInput" value="{{ filters.page }}">
      <div class="col-12 col-lg-4">
        <label class="form-label small mb-1">Search</label>
        <input type="text" name="q" class="form-control" placeholder="Search display text..." value="{{ filters.q }}">
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label small mb-1">Sort</label>
        <select name="sort" class="form-select">
          <option value="score_desc" {% if filters.sort=='score_desc' %}selected{% endif %}>Score ‚Üì</option>
          <option value="score_asc" {% if filters.sort=='score_asc' %}selected{% endif %}>Score ‚Üë</option>
          <option value="splits" {% if filters.sort=='splits' %}selected{% endif %}>Splits ‚Üì</option>
          <option value="lot" {% if filters.sort=='lot' %}selected{% endif %}>Lot SF ‚Üì</option>
          <option value="value" {% if filters.sort=='value' %}selected{% endif %}>Assessed Value ‚Üì</option>
          <option value="address_asc" {% if filters.sort=='address_asc' %}selected{% endif %}>Address A-Z</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <label class="form-label small mb-1">Rows</label>
        <select name="limit" class="form-select">
          {% for n in [25, 50, 100, 250, 500] %}
          <option value="{{ n }}" {% if filters.limit==n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-lg-4 d-flex gap-2 justify-content-lg-end">
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset('tier_a')">Tier A</button>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset('voted_up')">Voted Up</button>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyPreset('has_bundle')">Has Bundle</button>
        <button type="button" class="btn btn-sm btn-outline-secondary d-md-none" data-bs-toggle="collapse" data-bs-target="#filterDrawer">Filters</button>
      </div>

      <div class="collapse show d-md-block col-12" id="filterDrawer">
        <div class="row g-2 mt-1">
          <div class="col-12 col-md-2">
            <label class="form-label small mb-1">Tiers</label>
            <select name="tiers" id="tiersSelect" class="form-select" multiple size="4">
              {% for t in ['A','B','C','D','E','F'] %}
              <option value="{{ t }}" {% if t in filters.tiers %}selected{% endif %}>Tier {{ t }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label small mb-1">Use Types</label>
            <select name="use_types" id="useTypeSelect" class="form-select" multiple size="4"></select>
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label small mb-1">Tags Any</label>
            <input type="text" name="tags_any" class="form-control" placeholder="EDGE_X,RISK_Y" value="{{ filters.tags_any|join(',') }}">
          </div>
          <div class="col-12 col-md-2">
            <label class="form-label small mb-1">Tags None</label>
            <input type="text" name="tags_none" class="form-control" placeholder="EDGE_X,RISK_Y" value="{{ filters.tags_none|join(',') }}">
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label small mb-1">Score Min</label>
            <input type="number" name="score_min" class="form-control" value="{{ filters.score_min if filters.score_min is not none else '' }}">
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label small mb-1">Score Max</label>
            <input type="number" name="score_max" class="form-control" value="{{ filters.score_max if filters.score_max is not none else '' }}">
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label small mb-1">Vote</label>
            <select name="vote" class="form-select">
              <option value="" {% if not filters.vote %}selected{% endif %}>Any</option>
              <option value="up" {% if filters.vote=='up' %}selected{% endif %}>Voted Up</option>
              <option value="down" {% if filters.vote=='down' %}selected{% endif %}>Voted Down</option>
              <option value="none" {% if filters.vote=='none' %}selected{% endif %}>No Votes</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label small mb-1">Lead Status</label>
            <select name="lead_status" class="form-select">
              <option value="" {% if not filters.lead_status %}selected{% endif %}>Any</option>
              {% for s in ['new','researching','contacted','negotiating','closed_won','closed_lost','dead'] %}
              <option value="{{ s }}" {% if filters.lead_status==s %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label small mb-1">Has Bundle</label>
            <select name="has_bundle" class="form-select">
              <option value="" {% if filters.has_bundle is none %}selected{% endif %}>Any</option>
              <option value="1" {% if filters.has_bundle is sameas true %}selected{% endif %}>Yes</option>
              <option value="0" {% if filters.has_bundle is sameas false %}selected{% endif %}>No</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label small mb-1">OSINT Status</label>
            <input type="text" name="osint_status" class="form-control" value="{{ filters.osint_status or '' }}" placeholder="pending/complete">
          </div>
        </div>
      </div>

      <div class="col-12 d-flex gap-2 justify-content-end">
        <a href="{{ base_url }}/candidates" class="btn btn-outline-secondary">Clear all</a>
        <button type="submit" class="btn btn-primary">Apply filters</button>
      </div>
    </form>
    <div class="mt-2 d-flex flex-wrap gap-1" id="activeFilterChips"></div>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-2">
  <span class="text-muted small" id="resultCount">Showing <strong>{{ rows|length }}</strong> results</span>
  <div class="d-flex align-items-center gap-2 position-relative">
    <a href="{{ base_url }}/map" class="btn btn-sm btn-outline-secondary">üó∫Ô∏è View on Map</a>
    <button class="btn btn-sm btn-outline-secondary" id="columnGearBtn" type="button" aria-label="Columns">‚öôÔ∏è Columns</button>
    <div class="card border-0 shadow-sm p-2 position-absolute column-chooser" id="columnChooserPanel" style="display:none;right:0;top:42px;z-index:1000;"></div>
  </div>
</div>

<div class="card border-0 shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0" id="candidateTable">
      <thead class="table-dark">
        <tr>
          <th data-col="address">Address</th>
          <th data-col="score">Score</th>
          <th data-col="score_tier">Tier</th>
          <th data-col="vote">Vote</th>
          <th data-col="potential_splits">Splits</th>
          <th data-col="lot_sf">Lot SF</th>
          <th data-col="zone_code">Zone</th>
          <th data-col="subdivision_feasibility">Feasibility</th>
          <th data-col="economic_margin_pct">Margin %</th>
          <th data-col="tags">Tags</th>
          <th data-col="lead_status">Lead Status</th>
          <th data-col="has_bundle">Bundle</th>
          <th data-col="osint_status">OSINT</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        {% set c = row.candidate %}
        {% set p = c.parcel %}
        {% set cid = c.id|string %}
        <tr data-candidate-id="{{ cid }}" data-user-vote="{{ row.user_vote or '' }}">
          <td data-col="address" class="fw-semibold">
            <button class="btn btn-link p-0 text-start fw-semibold" onclick="openCandidateModal('{{ cid }}', '{{ p.id }}')">{{ p.address or "‚Äî" }}</button>
            <div class="small text-muted">{{ p.owner_name or "‚Äî" }}</div>
            <button
              class="btn btn-sm btn-outline-primary mt-1"
              onclick='openPromoteLeadModal({{ {"candidate_id": cid, "address": p.address or "", "score": c.score, "bundle": c.bundle_data, "lead_status": row.lead_status}|tojson }})'
            >Promote to Lead</button>
          </td>
          <td data-col="score">{{ c.score if c.score is not none else "‚Äî" }}</td>
          <td data-col="score_tier">
            {% if c.score_tier and c.score_tier.value == 'A' %}
              <span class="badge bg-success">A</span>
            {% elif c.score_tier and c.score_tier.value == 'B' %}
              <span class="badge bg-primary">B</span>
            {% elif c.score_tier and c.score_tier.value == 'C' %}
              <span class="badge bg-warning text-dark">C</span>
            {% elif c.score_tier and c.score_tier.value == 'D' %}
              <span class="badge text-white" style="background:#fd7e14">D</span>
            {% elif c.score_tier and c.score_tier.value == 'E' %}
              <span class="badge bg-danger">E</span>
            {% elif c.score_tier and c.score_tier.value == 'F' %}
              <span class="badge bg-dark">F</span>
            {% else %}
              <span class="badge bg-secondary">?</span>
            {% endif %}
          </td>
          <td data-col="vote">
            <div class="d-flex gap-1">
              <button id="row-up-{{ cid }}" class="btn btn-sm vote-btn {% if row.user_vote=='up' %}btn-success{% else %}btn-outline-success{% endif %}" onclick="event.stopPropagation(); doRating('{{ cid }}','up')">üëç <span id="row-up-count-{{ cid }}">{{ row.thumbs_up }}</span></button>
              <button id="row-down-{{ cid }}" class="btn btn-sm vote-btn {% if row.user_vote=='down' %}btn-danger{% else %}btn-outline-danger{% endif %}" onclick="event.stopPropagation(); doRating('{{ cid }}','down')">üëé <span id="row-down-count-{{ cid }}">{{ row.thumbs_down }}</span></button>
            </div>
          </td>
          <td data-col="potential_splits">{{ c.potential_splits if c.potential_splits is not none else '‚Äî' }}</td>
          <td data-col="lot_sf">
            {{ p.lot_sf | sqft if p.lot_sf else '‚Äî' }}
          </td>
          <td data-col="zone_code">
            <span class="badge bg-light text-dark border">{{ p.zone_code or '‚Äî' }}</span>
          </td>
          <td data-col="subdivision_feasibility">
            {% set feas_score = feasibility_scores.get(c.parcel_id|string) if feasibility_scores else None %}
            {% if feas_score is not none %}
              <span class="badge bg-info text-dark">{{ '%.0f'|format(feas_score) }}</span>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td data-col="economic_margin_pct">
            {% if c.economic_margin_pct is not none %}{{ '%.1f'|format(c.economic_margin_pct * 100) }}%{% else %}‚Äî{% endif %}
          </td>
          <td data-col="tags" class="small">
            {% for t in c.tags or [] %}
              {% if chip_map.get(t) %}<span class="badge bg-secondary">{{ chip_map[t] }}</span>{% endif %}
            {% endfor %}
            {% if not c.tags %}‚Äî{% endif %}
          </td>
          <td data-col="lead_status">{{ row.lead_status or '‚Äî' }}</td>
          <td data-col="has_bundle">{{ 'Yes' if row.has_bundle else 'No' }}</td>
          <td data-col="osint_status">{{ row.osint_status or '‚Äî' }}</td>
        </tr>
        {% endfor %}
        {% if not rows %}
        <tr><td colspan="13" class="text-center text-muted py-4">No candidates match your filters.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="columnChooserModal" tabindex="-1">
  <div class="modal-dialog modal-fullscreen-sm-down">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Columns</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="columnChooserModalBody"></div>
    </div>
  </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title" id="modalTitle">Candidate Detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body pt-2" id="modalBody">
        <div class="text-center py-4"><div class="spinner-border text-primary"></div></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="promoteLeadModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Promote to Lead</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-1">Address</div>
        <div id="promoteAddress" class="fw-semibold mb-2">‚Äî</div>
        <div class="small text-muted mb-1">Current score</div>
        <div id="promoteScore" class="mb-2">‚Äî</div>
        <div class="small text-muted mb-1">Bundle snapshot</div>
        <pre id="promoteBundle" class="small bg-light border rounded p-2 mb-2" style="max-height:160px;overflow:auto">None</pre>
        <div id="promoteDuplicateHint" class="alert alert-warning small d-none py-2"></div>
        <label class="form-label">Reason</label>
        <input id="promoteReason" class="form-control form-control-sm mb-2" placeholder="Why promote this candidate?" />
        <label class="form-label">Notes</label>
        <textarea id="promoteNotes" class="form-control form-control-sm" rows="3"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitPromoteLead()">Promote</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
<script>
const BASE = "{{ base_url }}";
const CURRENT_FILTERS = {{ filters | tojson }};
const CURRENT_USE_TYPES = {{ filters.use_types | tojson }};

const COLUMN_REGISTRY = [
  { key: "address", label: "Address", default: true, order: 0, sortable: true },
  { key: "score", label: "Score", default: true, order: 1, sortable: true },
  { key: "score_tier", label: "Tier", default: true, order: 2, sortable: true },
  { key: "vote", label: "Vote", default: true, order: 3, sortable: false },
  { key: "potential_splits", label: "Splits", default: true, order: 4, sortable: true },
  { key: "lot_sf", label: "Lot SF", default: false, order: 5, sortable: true },
  { key: "zone_code", label: "Zone", default: false, order: 6, sortable: true },
  { key: "subdivision_feasibility", label: "Feasibility", default: false, order: 7, sortable: true },
  { key: "economic_margin_pct", label: "Margin %", default: false, order: 8, sortable: true },
  { key: "tags", label: "Tags", default: false, order: 9, sortable: false },
  { key: "lead_status", label: "Lead Status", default: false, order: 10, sortable: true },
  { key: "has_bundle", label: "Bundle", default: false, order: 11, sortable: true },
  { key: "osint_status", label: "OSINT", default: false, order: 12, sortable: true },
];

const COLUMN_STORAGE_KEY = "column_config";
let _miniMap = null;
const modal = new bootstrap.Modal(document.getElementById('detailModal'));
const columnModal = new bootstrap.Modal(document.getElementById('columnChooserModal'));
const promoteLeadModal = new bootstrap.Modal(document.getElementById('promoteLeadModal'));
let pendingPromotePayload = null;

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function defaultColumnConfig() {
  return {
    order: [...COLUMN_REGISTRY].sort((a, b) => a.order - b.order).map((c) => c.key),
    visible: Object.fromEntries(COLUMN_REGISTRY.map((c) => [c.key, !!c.default])),
  };
}

function loadColumnConfig() {
  const fallback = defaultColumnConfig();
  try {
    const raw = localStorage.getItem(COLUMN_STORAGE_KEY);
    if (!raw) return fallback;
    const saved = JSON.parse(raw);
    const merged = defaultColumnConfig();
    if (Array.isArray(saved.order)) {
      const seen = new Set();
      merged.order = saved.order.filter((k) => COLUMN_REGISTRY.some((c) => c.key === k) && !seen.has(k) && seen.add(k));
      COLUMN_REGISTRY.forEach((c) => {
        if (!merged.order.includes(c.key)) merged.order.push(c.key);
      });
    }
    if (saved.visible && typeof saved.visible === 'object') {
      for (const col of COLUMN_REGISTRY) {
        if (Object.prototype.hasOwnProperty.call(saved.visible, col.key)) {
          merged.visible[col.key] = !!saved.visible[col.key];
        }
      }
    }
    return merged;
  } catch (e) {
    return fallback;
  }
}

function saveColumnConfig(config) {
  localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(config));
}

function applyColumnConfig(config) {
  const table = document.getElementById('candidateTable');
  if (!table) return;
  const headRow = table.querySelector('thead tr');
  const bodyRows = Array.from(table.querySelectorAll('tbody tr'));

  config.order.forEach((key) => {
    const th = headRow.querySelector(`th[data-col="${key}"]`);
    if (th) headRow.appendChild(th);
    bodyRows.forEach((row) => {
      const td = row.querySelector(`td[data-col="${key}"]`);
      if (td) row.appendChild(td);
    });
  });

  for (const col of COLUMN_REGISTRY) {
    const visible = !!config.visible[col.key];
    const display = visible ? '' : 'none';
    const th = headRow.querySelector(`th[data-col="${col.key}"]`);
    if (th) th.style.display = display;
    bodyRows.forEach((row) => {
      const td = row.querySelector(`td[data-col="${col.key}"]`);
      if (td) td.style.display = display;
    });
  }
}

function moveColumn(config, key, direction) {
  const idx = config.order.indexOf(key);
  if (idx < 0) return;
  const next = idx + direction;
  if (next < 0 || next >= config.order.length) return;
  const tmp = config.order[idx];
  config.order[idx] = config.order[next];
  config.order[next] = tmp;
}

function renderColumnControls(container, config) {
  if (!container) return;
  container.innerHTML = '';
  const list = document.createElement('div');
  list.className = 'd-flex flex-column gap-1';

  config.order.forEach((key) => {
    const col = COLUMN_REGISTRY.find((c) => c.key === key);
    if (!col) return;
    const row = document.createElement('div');
    row.className = 'd-flex align-items-center justify-content-between gap-2 border rounded px-2 py-1';
    row.innerHTML = `
      <label class="form-check m-0 d-flex align-items-center gap-2 flex-grow-1">
        <input class="form-check-input" type="checkbox" ${config.visible[key] ? 'checked' : ''} data-col-check="${key}">
        <span class="small">${escHtml(col.label)}</span>
      </label>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-secondary" data-col-up="${key}">‚Üë</button>
        <button type="button" class="btn btn-outline-secondary" data-col-down="${key}">‚Üì</button>
      </div>`;
    list.appendChild(row);
  });

  const footer = document.createElement('div');
  footer.className = 'd-flex justify-content-between mt-2';
  footer.innerHTML = `
    <button type="button" class="btn btn-sm btn-outline-secondary" id="resetColumnsBtn">Reset to defaults</button>
    <button type="button" class="btn btn-sm btn-primary" id="closeColumnsBtn">Done</button>`;

  container.appendChild(list);
  container.appendChild(footer);

  container.querySelectorAll('[data-col-check]').forEach((el) => {
    el.addEventListener('change', () => {
      config.visible[el.getAttribute('data-col-check')] = el.checked;
      saveColumnConfig(config);
      applyColumnConfig(config);
    });
  });
  container.querySelectorAll('[data-col-up]').forEach((el) => {
    el.addEventListener('click', () => {
      moveColumn(config, el.getAttribute('data-col-up'), -1);
      saveColumnConfig(config);
      applyColumnConfig(config);
      renderColumnPanels(config);
    });
  });
  container.querySelectorAll('[data-col-down]').forEach((el) => {
    el.addEventListener('click', () => {
      moveColumn(config, el.getAttribute('data-col-down'), 1);
      saveColumnConfig(config);
      applyColumnConfig(config);
      renderColumnPanels(config);
    });
  });
  const resetBtn = container.querySelector('#resetColumnsBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      const defaults = defaultColumnConfig();
      saveColumnConfig(defaults);
      applyColumnConfig(defaults);
      renderColumnPanels(defaults);
    });
  }
  const closeBtn = container.querySelector('#closeColumnsBtn');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      document.getElementById('columnChooserPanel').style.display = 'none';
      columnModal.hide();
    });
  }
}

function renderColumnPanels(config) {
  renderColumnControls(document.getElementById('columnChooserPanel'), config);
  renderColumnControls(document.getElementById('columnChooserModalBody'), config);
}

function getVoteState(candidateId) {
  const row = document.querySelector(`tr[data-candidate-id="${candidateId}"]`);
  const upCount = Number((document.getElementById(`row-up-count-${candidateId}`)?.textContent || 0));
  const downCount = Number((document.getElementById(`row-down-count-${candidateId}`)?.textContent || 0));
  return {
    user_vote: row ? (row.getAttribute('data-user-vote') || null) : null,
    thumbs_up: upCount,
    thumbs_down: downCount,
  };
}

function applyVoteState(candidateId, state) {
  const row = document.querySelector(`tr[data-candidate-id="${candidateId}"]`);
  if (row) row.setAttribute('data-user-vote', state.user_vote || '');
  const upCountEl = document.getElementById(`row-up-count-${candidateId}`);
  const downCountEl = document.getElementById(`row-down-count-${candidateId}`);
  if (upCountEl) upCountEl.textContent = state.thumbs_up;
  if (downCountEl) downCountEl.textContent = state.thumbs_down;

  const upBtn = document.getElementById(`row-up-${candidateId}`);
  const downBtn = document.getElementById(`row-down-${candidateId}`);
  if (upBtn) upBtn.className = `btn btn-sm vote-btn ${state.user_vote === 'up' ? 'btn-success' : 'btn-outline-success'}`;
  if (downBtn) downBtn.className = `btn btn-sm vote-btn ${state.user_vote === 'down' ? 'btn-danger' : 'btn-outline-danger'}`;

  const modalUp = document.getElementById(`upBtn-${candidateId}`);
  const modalDown = document.getElementById(`downBtn-${candidateId}`);
  const modalUpCount = document.getElementById(`upCount-${candidateId}`);
  const modalDownCount = document.getElementById(`downCount-${candidateId}`);
  if (modalUp) modalUp.className = `btn vote-btn ${state.user_vote === 'up' ? 'btn-success' : 'btn-outline-success'}`;
  if (modalDown) modalDown.className = `btn vote-btn ${state.user_vote === 'down' ? 'btn-danger' : 'btn-outline-danger'}`;
  if (modalUpCount) modalUpCount.textContent = state.thumbs_up;
  if (modalDownCount) modalDownCount.textContent = state.thumbs_down;
}

function nextVoteState(current, desired) {
  const next = {...current};
  if (current.user_vote === desired) {
    next.user_vote = null;
    if (desired === 'up') next.thumbs_up = Math.max(0, next.thumbs_up - 1);
    if (desired === 'down') next.thumbs_down = Math.max(0, next.thumbs_down - 1);
    return next;
  }
  if (current.user_vote === 'up') next.thumbs_up = Math.max(0, next.thumbs_up - 1);
  if (current.user_vote === 'down') next.thumbs_down = Math.max(0, next.thumbs_down - 1);
  if (desired === 'up') next.thumbs_up += 1;
  if (desired === 'down') next.thumbs_down += 1;
  next.user_vote = desired;
  return next;
}

async function doRating(candidateId, rating) {
  const before = getVoteState(candidateId);
  const optimistic = nextVoteState(before, rating);
  applyVoteState(candidateId, optimistic);

  try {
    const resp = await fetch(`${BASE}/api/candidate/${candidateId}/feedback`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({feedback_type: rating === 'up' ? 'thumbs_up' : 'thumbs_down'})
    });
    const data = await resp.json();
    if (!resp.ok || data.error) throw new Error(data.error || String(resp.status));
    applyVoteState(candidateId, {
      user_vote: data.user_vote,
      thumbs_up: data.thumbs_up,
      thumbs_down: data.thumbs_down,
    });
  } catch (e) {
    applyVoteState(candidateId, before);
    alert(`Vote update failed: ${e.message}`);
  }
}

function fmt(v, prefix='$') {
  if (v == null) return '‚Äî';
  if (typeof v === 'number') return prefix + v.toLocaleString();
  return v;
}

function confBadgeClass(conf) {
  if (conf === 'HIGH') return 'conf-badge-high';
  if (conf === 'MEDIUM') return 'conf-badge-medium';
  return 'conf-badge-low';
}

const TAG_LABELS = {
  RISK_WIDTH_CONSTRAINED: 'Width ‚ö†',
  RISK_ACCESS_TRACT_REQUIRED: 'Shared Access',
  RISK_ARV_MARGIN_THIN: 'Thin Margin ‚ö†',
  RISK_ECON_LOSS_AT_ASK: 'Loss at Ask ‚ùå',
  RISK_INFILL_PRICED_IN: 'Priced In',
  EDGE_ARBITRAGE_DEPTH_HIGH: 'Deep Arbitrage üéØ',
};

function chipText(tag) {
  return TAG_LABELS[tag] || tag;
}

async function openCandidateModal(id, parcelId='') {
  if (_miniMap) { _miniMap.remove(); _miniMap = null; }
  document.getElementById('modalTitle').textContent = 'Loading‚Ä¶';
  document.getElementById('modalBody').innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>';
  modal.show();

  const [d, fb, notesData] = await Promise.all([
    fetch(`${BASE}/api/candidate/${id}`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/feedback`).then(r => r.json()),
    fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r => r.json()),
  ]);

  const tierStyle = d.tier === 'D' ? 'style="background:#fd7e14"' : '';
  const tierCls = d.tier==='A'?'bg-success':d.tier==='B'?'bg-primary':d.tier==='C'?'bg-warning text-dark':d.tier==='D'?'':d.tier==='E'?'bg-danger':'bg-dark';

  document.getElementById('modalTitle').innerHTML =
    `<span id="tierBadge-${d.id}" class="badge ${tierCls} me-2" ${tierStyle}>Tier ${d.tier || '?'}</span>${d.address || 'No address'}`;

  const tagsHtml = (d.tags || []).map(t =>
    `<span class="badge me-1 mb-1" style="background:#e8f4fd;color:#0d6efd;border:1px solid #bee5fd">${chipText(escHtml(t))}</span>`
  ).join('');

  const notesHtml = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';

  const upActive = fb.user_vote === 'up' ? 'btn-success' : 'btn-outline-success';
  const downActive = fb.user_vote === 'down' ? 'btn-danger' : 'btn-outline-danger';
  const detailUrl = `${BASE}/property/${d.parcel_id || parcelId || ''}`;

  document.getElementById('modalBody').innerHTML = `
    <div class="row g-3">
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üìç Property</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Address</td><td class="fw-semibold">${d.address || '‚Äî'}</td></tr>
          <tr><td class="text-muted">County</td><td>${d.county || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Lot Size</td><td>${d.lot_sf ? d.lot_sf.toLocaleString() + ' sf<br><span class="text-muted">(' + d.lot_acres + ' ac)</span>' : '‚Äî'}</td></tr>
          <tr><td class="text-muted">Zone</td><td><strong>${d.zone_code || '‚Äî'}</strong></td></tr>
          ${d.score != null ? `<tr><td class="text-muted">Score</td><td><span class="badge bg-secondary">${d.score} pts</span></td></tr>` : ''}
        </table>
      </div>
      <div class="col-md-6">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üë§ Owner</h6>
        <table class="table table-sm table-borderless mb-0">
          <tr><td class="text-muted" style="width:40%">Name</td><td class="fw-semibold">${d.owner_name || '‚Äî'}</td></tr>
          <tr><td class="text-muted">Mailing</td><td class="small">${d.owner_address || '‚Äî'}</td></tr>
        </table>
      </div>
      <div class="col-12">
        ${tagsHtml ? '<div class="mt-2">'+tagsHtml+'</div>' : '<span class="text-muted small">No tags</span>'}
      </div>
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">‚≠ê Vote</h6>
        <div class="d-flex gap-2 align-items-center mb-2">
          <button id="upBtn-${d.id}" class="btn vote-btn ${upActive}" onclick="doRating('${d.id}','up')">üëç <span id="upCount-${d.id}">${fb.thumbs_up}</span></button>
          <button id="downBtn-${d.id}" class="btn vote-btn ${downActive}" onclick="doRating('${d.id}','down')">üëé <span id="downCount-${d.id}">${fb.thumbs_down}</span></button>
        </div>
      </div>
      <div class="col-12 border-top pt-3">
        <h6 class="fw-bold text-muted text-uppercase small mb-2">üí¨ Notes</h6>
        <div id="notesList-${d.id}" class="mb-2">${notesHtml}</div>
        <div class="d-flex gap-2">
          <input id="noteInput-${d.id}" type="text" class="form-control form-control-sm" placeholder="Add a note..." style="max-width:300px" onkeydown="if(event.key==='Enter'){addNote('${d.id}')}">
          <button class="btn btn-sm btn-outline-primary" onclick="addNote('${d.id}')">Add note</button>
        </div>
      </div>
      <div class="col-12 border-top pt-3 d-flex justify-content-end">
        <a href="${detailUrl}" class="btn btn-primary btn-sm">View Full Details ‚Üí</a>
      </div>
    </div>
  `;

}

function openPromoteLeadModal(payload) {
  pendingPromotePayload = payload || null;
  if (!pendingPromotePayload || !pendingPromotePayload.candidate_id) return;
  document.getElementById('promoteAddress').textContent = pendingPromotePayload.address || '‚Äî';
  document.getElementById('promoteScore').textContent = pendingPromotePayload.score != null ? String(pendingPromotePayload.score) : '‚Äî';
  document.getElementById('promoteBundle').textContent = pendingPromotePayload.bundle ? JSON.stringify(pendingPromotePayload.bundle, null, 2) : 'None';
  document.getElementById('promoteReason').value = '';
  document.getElementById('promoteNotes').value = '';

  const hint = document.getElementById('promoteDuplicateHint');
  if (pendingPromotePayload.lead_status && !['dead', 'closed_lost'].includes(pendingPromotePayload.lead_status)) {
    hint.classList.remove('d-none');
    hint.textContent = `Existing lead status: ${pendingPromotePayload.lead_status}. Promotion will fail unless that lead is dead or closed_lost.`;
  } else {
    hint.classList.add('d-none');
    hint.textContent = '';
  }
  promoteLeadModal.show();
}

async function submitPromoteLead() {
  if (!pendingPromotePayload || !pendingPromotePayload.candidate_id) return;
  const reason = document.getElementById('promoteReason').value.trim();
  const notes = document.getElementById('promoteNotes').value.trim();
  const resp = await fetch(`${BASE}/api/leads`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({
      candidate_id: pendingPromotePayload.candidate_id,
      reason,
      notes,
    }),
  });
  const data = await resp.json().catch(() => ({}));
  if (resp.status === 409 && data.lead_id) {
    window.location.href = `${BASE}/leads/${data.lead_id}`;
    return;
  }
  if (!resp.ok || !data.lead_id) {
    alert(data.error || 'Failed to promote lead');
    return;
  }
  promoteLeadModal.hide();
  window.location.href = `${BASE}/leads/${data.lead_id}`;
}

async function addNote(id) {
  const inp = document.getElementById(`noteInput-${id}`);
  const note = inp.value.trim();
  if (!note) return;
  await fetch(`${BASE}/api/candidate/${id}/notes`, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({note}),
  });
  inp.value = '';
  const notesData = await fetch(`${BASE}/api/candidate/${id}/notes?limit=3`).then(r=>r.json());
  const html = notesData.length
    ? notesData.map(n => `
        <div class="d-flex gap-2 align-items-start mb-1">
          <span class="text-muted small">üí¨</span>
          <div class="small">
            <span class="text-dark">${escHtml(n.note)}</span>
            <span class="text-muted ms-1" style="font-size:0.7rem">${n.created_at ? n.created_at.slice(0,10) : ''}</span>
          </div>
        </div>`).join('')
    : '<div class="text-muted small">No notes yet.</div>';
  document.getElementById(`notesList-${id}`).innerHTML = html;
}

async function loadUseTypes() {
  const select = document.getElementById('useTypeSelect');
  if (!select) return;
  try {
    const data = await fetch(`${BASE}/api/use-types`).then(r => r.json());
    select.innerHTML = '';
    (data.use_types || []).forEach((useType) => {
      const opt = document.createElement('option');
      opt.value = useType;
      opt.textContent = useType;
      if (CURRENT_USE_TYPES.includes(useType)) opt.selected = true;
      select.appendChild(opt);
    });
  } catch (e) {
    select.innerHTML = '';
  }
}

function renderActiveFilterChips() {
  const container = document.getElementById('activeFilterChips');
  if (!container) return;
  container.innerHTML = '';
  const entries = [];
  const params = new URLSearchParams(window.location.search);
  params.forEach((value, key) => {
    if (!value || key === 'page') return;
    entries.push([key, value]);
  });
  entries.forEach(([key, value]) => {
    const chip = document.createElement('span');
    chip.className = 'filter-chip';
    chip.textContent = `${key}: ${value}`;
    container.appendChild(chip);
  });
}

function applyPreset(preset) {
  const form = document.getElementById('filterForm');
  if (!form) return;
  if (preset === 'tier_a') {
    const tiers = form.querySelector('#tiersSelect');
    Array.from(tiers.options).forEach((o) => { o.selected = (o.value === 'A'); });
  }
  if (preset === 'voted_up') {
    const vote = form.querySelector('select[name="vote"]');
    vote.value = 'up';
  }
  if (preset === 'has_bundle') {
    const hasBundle = form.querySelector('select[name="has_bundle"]');
    hasBundle.value = '1';
  }
  form.querySelector('#pageInput').value = '1';
  form.submit();
}

const columnConfig = loadColumnConfig();
applyColumnConfig(columnConfig);
renderColumnPanels(columnConfig);
loadUseTypes();
renderActiveFilterChips();

document.getElementById('columnGearBtn').addEventListener('click', () => {
  if (window.innerWidth < 768) {
    columnModal.show();
    return;
  }
  const panel = document.getElementById('columnChooserPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
});

document.addEventListener('click', (event) => {
  const panel = document.getElementById('columnChooserPanel');
  const gear = document.getElementById('columnGearBtn');
  if (!panel || panel.style.display === 'none') return;
  if (!panel.contains(event.target) && !gear.contains(event.target)) panel.style.display = 'none';
});

document.querySelectorAll('#filterForm input, #filterForm select').forEach((el) => {
  el.addEventListener('change', () => {
    const page = document.getElementById('pageInput');
    if (page) page.value = '1';
  });
});
</script>
{% endblock %}
